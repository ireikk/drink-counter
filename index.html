<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Drink Counter</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b1220" />
  <style>
    :root{
      --bg:#0b1220; --card:#0f1a2e; --card2:#0c1628;
      --text:#e8eefc; --muted:#a8b3cc;
      --ok:#0b3d2e; --warn:#6b4b00; --limit:#5b1010;
      --btn:#1f6feb; --btn2:#27324a; --danger:#b42318;
      --ring: rgba(255,255,255,.08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(31,111,235,.25), transparent),
                  radial-gradient(900px 500px at 90% 30%, rgba(16,185,129,.18), transparent),
                  var(--bg);
      color:var(--text);
      padding:18px;
    }
    .wrap{max-width:980px;margin:0 auto; display:grid; gap:14px;}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--ring);
      border-radius: var(--radius);
      padding:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center;}
    .space{justify-content:space-between;}
    .title{font-size:14px; color:var(--muted); letter-spacing:.04em;}
    .big{font-size:44px; font-weight:800; line-height:1;}
    .sub{color:var(--muted); font-size:13px;}
    .pill{
      padding:10px 12px; border-radius:999px; border:1px solid var(--ring);
      background: rgba(0,0,0,.2);
      font-size:13px; color:var(--muted);
    }
    .status{
      width:100%;
      padding:12px 14px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      font-weight:700;
    }
    .btn{
      border:0; border-radius:14px;
      padding:12px 14px; font-weight:800;
      color:white; cursor:pointer;
      background: var(--btn);
      box-shadow: 0 8px 20px rgba(31,111,235,.25);
      min-width:120px;
    }
    .btn.secondary{background: var(--btn2); box-shadow:none;}
    .btn.danger{background: var(--danger); box-shadow:none;}
    .btn:active{transform: translateY(1px);}
    .grid5{display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap:10px;}
    .grid3{display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px;}
    .chip{
      background: rgba(0,0,0,.22);
      border:1px solid var(--ring);
      border-radius: 14px;
      padding:12px 10px;
      cursor:pointer;
      text-align:center;
      user-select:none;
    }
    .chip .emoji{font-size:22px; display:block; margin-bottom:6px;}
    .chip .lbl{font-size:12px; color:var(--muted);}
    .chip.active{
      outline: 2px solid rgba(31,111,235,.55);
      background: rgba(31,111,235,.16);
    }
    .kpis{display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px;}
    .kpi{padding:12px; border-radius:16px; background: rgba(0,0,0,.18); border:1px solid var(--ring);}
    .kpi .v{font-size:18px; font-weight:800;}
    .kpi .t{font-size:12px; color:var(--muted); margin-top:4px;}
    .log{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px; border:1px solid var(--ring);}
    .log th,.log td{padding:10px 10px; font-size:13px; border-bottom:1px solid rgba(255,255,255,.06);}
    .log th{color:var(--muted); text-align:left; font-weight:700; background: rgba(0,0,0,.18);}
    .log tr:last-child td{border-bottom:0;}
    .del{
      border:0; background: rgba(180,35,24,.15); color:#ffd6d6;
      border-radius:10px; padding:6px 10px; font-weight:800; cursor:pointer;
    }
    .hint{font-size:12px; color:var(--muted);}
    @media (max-width:820px){
      .grid5{grid-template-columns: repeat(2, minmax(0,1fr));}
      .kpis{grid-template-columns: repeat(2, minmax(0,1fr));}
    }
  </style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div class="row space">
      <div>
        <div class="title">Today</div>
        <div class="big" id="countToday">0</div>
        <div class="sub" id="dateStr"></div>
      </div>
      <div class="row" style="gap:10px;">
        <div class="pill">åˆ†è§£é€Ÿåº¦: <b id="metRateTxt">7</b> g/æ™‚</div>
        <button class="btn secondary" id="clearTodayBtn">ä»Šæ—¥ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>

    <div style="height:10px"></div>

    <div class="kpis">
      <div class="kpi">
        <div class="v"><span id="lastTime">--:--</span></div>
        <div class="t">ç›´è¿‘ã®å…¥åŠ›æ™‚åˆ»</div>
      </div>
      <div class="kpi">
        <div class="v"><span id="sincePrev">--</span></div>
        <div class="t">å‰å›ã‹ã‚‰ã®çµŒé</div>
      </div>
      <div class="kpi">
        <div class="v"><span id="totalG">0.0</span> g</div>
        <div class="t">ä»Šæ—¥ã®ç´¯è¨ˆã‚¢ãƒ«ã‚³ãƒ¼ãƒ«</div>
      </div>
      <div class="kpi">
        <div class="v"><span id="soberAt">--:--</span></div>
        <div class="t">æ¶ˆè²»å®Œäº†äºˆå®š</div>
      </div>
    </div>

    <div style="height:10px"></div>
    <div class="status" id="statusBar">OKï¼ˆã¾ã ä½™è£•ï¼‰</div>
    <div class="hint" style="margin-top:8px;">
      ç›®å®‰ï¼šç´”ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«(g) = ml Ã— åº¦æ•° Ã— 0.789 / 100ã€‚â€»åº—ã«ã‚ˆã‚‹å·®ã¯ã€Œè¨­å®šã€ã§å¾Œã‹ã‚‰èª¿æ•´å¯èƒ½ã«ã—ã¾ã™ã€‚
    </div>
  </div>

  <div class="card">
    <div class="row space">
      <div class="title">ç™»éŒ²ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ã§é¸ã¶ï¼‰</div>
      <div class="pill">1æ¯ã®ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«: <b id="thisG">0.0</b> g</div>
    </div>

    <div style="height:10px"></div>

    <div class="grid5" id="drinkGrid"></div>

    <div style="height:12px"></div>

    <div class="row space">
      <div class="title">é‡</div>
      <div class="pill" id="sizeDesc">Sï¼ˆãƒŸãƒ‹ï¼‰/ Mï¼ˆã‚¸ãƒ§ãƒƒã‚­ï¼‰/ Lï¼ˆãƒ¡ã‚¬ or ç“¶ï¼‰</div>
    </div>
    <div style="height:10px"></div>
    <div class="grid3" id="sizeGrid"></div>

    <div style="height:12px"></div>
    <div class="row">
      <button class="btn" id="addBtn">ï¼‹ è¿½åŠ </button>
      <button class="btn secondary" id="undoBtn" title="ç›´å‰ã®å…¥åŠ›ã‚’å–ã‚Šæ¶ˆã—ï¼ˆ1å›ï¼‰">å–ã‚Šæ¶ˆã—</button>
    </div>
  </div>

  <div class="card">
    <div class="row space">
      <div class="title">Logï¼ˆä»Šæ—¥ï¼‰</div>
      <button class="btn danger" id="clearLogBtn">ãƒ­ã‚°æ¶ˆå»</button>
    </div>
    <div style="height:10px"></div>

    <table class="log">
      <thead>
        <tr>
          <th style="width:110px;">æ™‚åˆ»</th>
          <th>å†…å®¹</th>
          <th style="width:120px;">g</th>
          <th style="width:140px;">å‰å›ã‹ã‚‰</th>
          <th style="width:90px;">å‰Šé™¤</th>
        </tr>
      </thead>
      <tbody id="logBody">
        <tr><td colspan="5" class="sub">(no log)</td></tr>
      </tbody>
    </table>
  </div>

</div>

<script>
  // ====== è¨­å®šï¼ˆPhase1ï¼‰ ======
  const ETHANOL_DENSITY = 0.789;

  const settings = {
    metabolize_g_per_hour: 7, // Kyo: å®‰å…¨å¯„ã‚Š
    thresholds_g: { ok: 20, warn: 40, limit: 60 }, // ä»®ï¼ˆPhase2ã§UIè¨­å®šåŒ–ï¼‰
  };

  // ç¨®é¡ã¨åº¦æ•°ã€ã‚µã‚¤ã‚ºåˆ¥mlï¼ˆä»®ï¼šã‚ã¨ã§èª¿æ•´UIï¼‰
  const DRINKS = [
    { key:"beer",   label:"ãƒ“ãƒ¼ãƒ«",        emoji:"ğŸº", abv:5.0,  ml:{ S:200, M:400, L:650 } },
    { key:"highball",label:"ãƒã‚¤ãƒœãƒ¼ãƒ«",    emoji:"ğŸ¥ƒ", abv:7.0,  ml:{ S:250, M:350, L:500 } },
    { key:"wine",   label:"ãƒ¯ã‚¤ãƒ³",        emoji:"ğŸ·", abv:12.0, ml:{ S:100, M:150, L:250 } },
    { key:"craft",  label:"ã‚¯ãƒ©ãƒ•ãƒˆ",      emoji:"ğŸºâœ¨", abv:6.5, ml:{ S:200, M:400, L:650 } },
    { key:"brandy", label:"ãƒ–ãƒ©ãƒ³ãƒ‡ãƒ¼",    emoji:"ğŸ¥ƒâœ¨", abv:40.0, ml:{ S:30,  M:45,  L:60  } },
  ];

  // ====== ä¿å­˜ï¼ˆä»Šæ—¥å˜ä½ï¼‰ ======
  const todayKey = () => {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `drinklog_${y}-${m}-${day}`;
  };

  const loadLog = () => {
    try{
      const raw = localStorage.getItem(todayKey());
      return raw ? JSON.parse(raw) : [];
    }catch(e){ return []; }
  };
  const saveLog = (log) => localStorage.setItem(todayKey(), JSON.stringify(log));

  // ====== è¨ˆç®— ======
  const gramsOfAlcohol = (ml, abvPercent) => (ml * (abvPercent/100) * ETHANOL_DENSITY);

  const fmtTime = (d) => {
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    return `${hh}:${mm}`;
  };
  const fmtDur = (ms) => {
    const min = Math.max(0, Math.round(ms/60000));
    const h = Math.floor(min/60);
    const m = min%60;
    if (min===0) return "0åˆ†";
    if (h===0) return `${m}åˆ†`;
    return `${h}æ™‚é–“${m}åˆ†`;
  };

  // ====== UI state ======
  let selectedDrinkKey = "highball";
  let selectedSize = "M";
  let lastDeleted = null; // undoç”¨

  // ====== DOM ======
  const drinkGrid = document.getElementById("drinkGrid");
  const sizeGrid  = document.getElementById("sizeGrid");
  const thisGEl   = document.getElementById("thisG");
  const logBody   = document.getElementById("logBody");

  const countTodayEl = document.getElementById("countToday");
  const dateStrEl = document.getElementById("dateStr");
  const lastTimeEl = document.getElementById("lastTime");
  const sincePrevEl = document.getElementById("sincePrev");
  const totalGEl = document.getElementById("totalG");
  const soberAtEl = document.getElementById("soberAt");
  const statusBar = document.getElementById("statusBar");
  document.getElementById("metRateTxt").textContent = settings.metabolize_g_per_hour;

  // ====== Render helpers ======
  const getDrink = (key) => DRINKS.find(d=>d.key===key);

  const computeThisG = () => {
    const d = getDrink(selectedDrinkKey);
    const ml = d.ml[selectedSize];
    return gramsOfAlcohol(ml, d.abv);
  };

  const renderDrinkChips = () => {
    drinkGrid.innerHTML = "";
    DRINKS.forEach(d=>{
      const div = document.createElement("div");
      div.className = "chip" + (d.key===selectedDrinkKey ? " active": "");
      div.innerHTML = `<span class="emoji">${d.emoji}</span><div style="font-weight:900">${d.label}</div><div class="lbl">${d.abv}%</div>`;
      div.onclick = ()=>{ selectedDrinkKey = d.key; renderAll(); };
      drinkGrid.appendChild(div);
    });
  };

  const renderSizeChips = () => {
    sizeGrid.innerHTML = "";
    const d = getDrink(selectedDrinkKey);
    ["S","M","L"].forEach(s=>{
      const ml = d.ml[s];
      const label = (s==="S") ? "Sï¼ˆãƒŸãƒ‹ï¼‰" : (s==="M" ? "Mï¼ˆã‚¸ãƒ§ãƒƒã‚­ï¼‰" : "Lï¼ˆãƒ¡ã‚¬/ç“¶ï¼‰");
      const div = document.createElement("div");
      div.className = "chip" + (s===selectedSize ? " active": "");
      div.innerHTML = `<div style="font-weight:900">${label}</div><div class="lbl">${ml} ml</div>`;
      div.onclick = ()=>{ selectedSize = s; renderAll(); };
      sizeGrid.appendChild(div);
    });
  };

  const calcTotals = (log) => {
    const totalG = log.reduce((sum,x)=>sum + x.g, 0);
    const hoursNeeded = totalG / settings.metabolize_g_per_hour;
    const now = new Date();
    const soberAt = new Date(now.getTime() + hoursNeeded*3600*1000);
    return { totalG, hoursNeeded, soberAt };
  };

  const setStatus = (totalG) => {
    const { ok, warn, limit } = settings.thresholds_g;
    if (totalG >= limit){
      statusBar.textContent = "ä¸Šé™ï¼ˆSTOPï¼‰";
      statusBar.style.background = "rgba(180,35,24,.28)";
      statusBar.style.borderColor = "rgba(180,35,24,.55)";
      return;
    }
    if (totalG >= warn){
      statusBar.textContent = "æ³¨æ„ï¼ˆãƒšãƒ¼ã‚¹è½ã¨ã™ï¼‰";
      statusBar.style.background = "rgba(255,170,0,.20)";
      statusBar.style.borderColor = "rgba(255,170,0,.45)";
      return;
    }
    if (totalG >= ok){
      statusBar.textContent = "é©é‡ï¼ˆãã‚ãã‚æ„è­˜ï¼‰";
      statusBar.style.background = "rgba(16,185,129,.16)";
      statusBar.style.borderColor = "rgba(16,185,129,.35)";
      return;
    }
    statusBar.textContent = "OKï¼ˆã¾ã ä½™è£•ï¼‰";
    statusBar.style.background = "rgba(16,185,129,.10)";
    statusBar.style.borderColor = "rgba(255,255,255,.12)";
  };

  const renderLog = (log) => {
    if (log.length===0){
      logBody.innerHTML = `<tr><td colspan="5" class="sub">(no log)</td></tr>`;
      return;
    }
    logBody.innerHTML = "";
    for (let i=0;i<log.length;i++){
      const e = log[i];
      const prev = log[i-1];
      const delta = prev ? fmtDur(e.t - prev.t) : "--";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${fmtTime(new Date(e.t))}</td>
        <td>${e.emoji} ${e.label} / ${e.size}ï¼ˆ${e.ml}mlãƒ»${e.abv}%ï¼‰</td>
        <td><b>${e.g.toFixed(1)}</b> g</td>
        <td>${delta}</td>
        <td><button class="del" data-id="${e.id}">å‰Šé™¤</button></td>
      `;
      logBody.appendChild(tr);
    }
    // delete handlers
    [...logBody.querySelectorAll("button.del")].forEach(btn=>{
      btn.onclick = ()=>{
        const id = btn.getAttribute("data-id");
        const current = loadLog();
        const idx = current.findIndex(x=>x.id===id);
        if (idx>=0){
          lastDeleted = current[idx];
          current.splice(idx,1);
          saveLog(current);
          renderAll();
        }
      };
    });
  };

  const renderHeader = (log) => {
    const now = new Date();
    dateStrEl.textContent = now.toISOString().slice(0,10);

    countTodayEl.textContent = String(log.length);

    const last = log[log.length-1];
    if (!last){
      lastTimeEl.textContent = "--:--";
      sincePrevEl.textContent = "--";
    } else {
      lastTimeEl.textContent = fmtTime(new Date(last.t));
      const prev = log[log.length-2];
      sincePrevEl.textContent = prev ? fmtDur(last.t - prev.t) : "--";
    }

    const { totalG, soberAt } = calcTotals(log);
    totalGEl.textContent = totalG.toFixed(1);
    soberAtEl.textContent = log.length ? fmtTime(soberAt) : "--:--";
    setStatus(totalG);
  };

  const renderAll = () => {
    renderDrinkChips();
    renderSizeChips();
    const g = computeThisG();
    thisGEl.textContent = g.toFixed(1);

    const log = loadLog();
    renderHeader(log);
    renderLog(log);
  };

  // ====== actions ======
  document.getElementById("addBtn").onclick = () => {
    const d = getDrink(selectedDrinkKey);
    const ml = d.ml[selectedSize];
    const g = gramsOfAlcohol(ml, d.abv);
    const log = loadLog();
    const entry = {
      id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random(),
      t: Date.now(),
      key: d.key,
      label: d.label,
      emoji: d.emoji,
      size: selectedSize,
      ml,
      abv: d.abv,
      g
    };
    log.push(entry);
    saveLog(log);
    lastDeleted = null;
    renderAll();
  };

  document.getElementById("undoBtn").onclick = () => {
    if (!lastDeleted) return;
    const log = loadLog();
    log.push(lastDeleted);
    log.sort((a,b)=>a.t-b.t);
    saveLog(log);
    lastDeleted = null;
    renderAll();
  };

  document.getElementById("clearLogBtn").onclick = () => {
    if (!confirm("ä»Šæ—¥ã®ãƒ­ã‚°ã‚’å…¨éƒ¨æ¶ˆã—ã¾ã™ã€‚OKï¼Ÿ")) return;
    saveLog([]);
    lastDeleted = null;
    renderAll();
  };

  document.getElementById("clearTodayBtn").onclick = () => {
    if (!confirm("ä»Šæ—¥ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ­ã‚°æ¶ˆå»ï¼‰ã—ã¾ã™ã€‚OKï¼Ÿ")) return;
    saveLog([]);
    lastDeleted = null;
    renderAll();
  };

  // PWA
  if ("serviceWorker" in navigator){
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }

  renderAll();
</script>
</body>
</html>
