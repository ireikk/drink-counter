<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#071428" />
  <title>Drink Counter</title>

  <!-- PWA (æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å‰æ) -->
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="apple-touch-icon" href="./icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    :root{
      --bg1:#071428;
      --bg2:#0b2336;
      --card:#0f2233;
      --card2:#0b1a28;
      --text:#eaf2ff;
      --muted:rgba(234,242,255,.65);

      --accent:#2b79ff;
      --accent2:#24d18f;
      --warn:#ffb020;
      --danger:#ff3b30;

      --shadow: 0 20px 60px rgba(0,0,0,.35);
      --radius: 22px;
      --radius2: 16px;

      --border: 1px solid rgba(255,255,255,.08);
      --border2: 1px solid rgba(255,255,255,.12);
    }

    /* ====== THEME SWITCH (ãƒšãƒ¼ã‚¸å…¨ä½“ã®è‰²) ====== */
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", "Helvetica Neue", Arial, sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 700px at 20% 10%, var(--bg2), var(--bg1));
      min-height:100vh;
    }
    body[data-status="ok"]{
      --bg1:#071428;
      --bg2:#0b2a2a;
      --accent:#2b79ff;
      --accent2:#24d18f;
    }
    body[data-status="warn"]{
      --bg1:#1a1408;
      --bg2:#2b1f0b;
      --accent:#ffb020;
      --accent2:#ffd36a;
    }
    body[data-status="stop"]{
      --bg1:#1b0a0c;
      --bg2:#2b0f14;
      --accent:#ff3b30;
      --accent2:#ff6b5f;
    }

    .wrap{ max-width: 1100px; margin: 0 auto; padding: 22px 16px 40px; }
    .topCard{
      border-radius: 28px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: var(--border);
      box-shadow: var(--shadow);
      padding: 18px 18px 14px;
    }
    .row{ display:flex; gap:14px; flex-wrap:wrap; align-items:stretch; }
    .row.between{ justify-content:space-between; align-items:center; }
    .titleBlock{ display:flex; flex-direction:column; gap:4px; }
    .titleBlock .small{ font-size:12px; color: var(--muted); }
    .titleBlock .big{ font-size:46px; font-weight:800; line-height:1; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.22);
      border: var(--border);
      color: var(--muted);
      font-size:12px;
      backdrop-filter: blur(10px);
    }
    .btn{
      border:0;
      cursor:pointer;
      border-radius: 14px;
      padding: 10px 14px;
      color: var(--text);
      background: rgba(255,255,255,.08);
      border: var(--border);
      font-weight:700;
      letter-spacing:.02em;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: color-mix(in srgb, var(--accent) 85%, black 15%);
      border: 1px solid color-mix(in srgb, var(--accent) 55%, transparent);
    }
    .btn.danger{
      background: color-mix(in srgb, var(--danger) 85%, black 15%);
      border: 1px solid color-mix(in srgb, var(--danger) 55%, transparent);
    }
    .btn.ghost{
      background: rgba(255,255,255,.06);
    }

    .kpis{ margin-top: 14px; display:grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .kpi{
      border-radius: var(--radius2);
      padding: 12px 14px;
      background: rgba(0,0,0,.18);
      border: var(--border);
      min-height:74px;
    }
    .kpi .label{ font-size:12px; color: var(--muted); }
    .kpi .value{ font-size:22px; font-weight:800; margin-top:6px; }
    .kpi .sub{ font-size:12px; color: var(--muted); margin-top:4px; }

    .statusBar{
      margin-top: 12px;
      border-radius: 16px;
      padding: 12px 14px;
      border: 1px solid color-mix(in srgb, var(--accent) 35%, rgba(255,255,255,.12));
      background: color-mix(in srgb, var(--accent) 18%, rgba(0,0,0,.20));
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .statusBar .main{ font-weight:900; }
    .statusBar .note{ font-size:12px; color: var(--muted); }

    .panel{
      margin-top: 16px;
      border-radius: 24px;
      padding: 16px;
      background: rgba(255,255,255,.04);
      border: var(--border);
      box-shadow: 0 12px 40px rgba(0,0,0,.25);
    }
    .panelHeader{
      display:flex; justify-content:space-between; align-items:center; gap: 12px;
      margin-bottom: 12px;
    }
    .panelHeader h3{
      margin:0;
      font-size:14px;
      letter-spacing:.08em;
      color: var(--muted);
      font-weight:800;
    }

    /* drink selector */
    .gridDrinks{ display:grid; grid-template-columns: repeat(5, 1fr); gap: 12px; }
    .tile{
      border-radius: 18px;
      padding: 14px 12px;
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.08);
      cursor:pointer;
      transition: transform .06s ease;
      display:flex; flex-direction:column; align-items:center; gap:8px;
      min-height:86px;
      user-select:none;
    }
    .tile:active{ transform: translateY(1px); }
    .tile .emoji{ font-size:20px; }
    .tile .name{ font-weight:900; font-size:13px; }
    .tile .abv{ font-size:12px; color: var(--muted); }
    .tile.selected{
      border: 2px solid color-mix(in srgb, var(--accent) 70%, transparent);
      background: color-mix(in srgb, var(--accent) 14%, rgba(0,0,0,.22));
      box-shadow: 0 0 0 2px rgba(0,0,0,.12) inset;
    }

    .gridSizes{ margin-top: 12px; display:grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .sizeTile{
      border-radius: 18px;
      padding: 14px 12px;
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.08);
      cursor:pointer;
      user-select:none;
      display:flex; flex-direction:column; align-items:center; gap:4px;
    }
    .sizeTile .name{ font-weight:900; }
    .sizeTile .ml{ font-size:12px; color: var(--muted); }
    .sizeTile.selected{
      border: 2px solid color-mix(in srgb, var(--accent) 70%, transparent);
      background: color-mix(in srgb, var(--accent) 14%, rgba(0,0,0,.22));
    }

    .actions{ display:flex; gap:12px; margin-top: 12px; }

    /* log table */
    .logWrap{ margin-top: 14px; }
    table{ width:100%; border-collapse: collapse; overflow:hidden; border-radius: 16px; }
    thead th{
      text-align:left;
      font-size:12px;
      color: var(--muted);
      font-weight:900;
      padding: 10px 10px;
      background: rgba(0,0,0,.22);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    tbody td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      font-size:13px;
    }
    tbody tr:last-child td{ border-bottom: 0; }
    .right{ text-align:right; }
    .center{ text-align:center; }
    .miniBtn{
      padding: 6px 10px;
      border-radius: 12px;
      font-weight:900;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
    }
    .miniBtn.danger{
      background: rgba(255,59,48,.18);
      border-color: rgba(255,59,48,.35);
    }
    .muted{ color: var(--muted); }

    /* calendar */
    .calHeader{
      display:flex; justify-content:space-between; align-items:center; gap: 10px;
      margin: 6px 0 10px;
    }
    .calHeader .monthLabel{
      font-weight:900;
      letter-spacing:.04em;
    }
    .calGrid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
    }
    .dow{
      font-size:12px;
      color: var(--muted);
      font-weight:800;
      text-align:center;
      padding: 4px 0 2px;
    }
    .dayCell{
      border-radius: 16px;
      min-height: 76px;
      padding: 10px 10px 8px;
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.08);
      cursor:pointer;
      position: relative;
      user-select:none;
    }
    .dayCell:hover{ border-color: rgba(255,255,255,.14); }
    .dayNum{
      font-weight:900;
      font-size:14px;
      opacity: .95;
    }
    .badges{
      position:absolute;
      right:10px;
      top:10px;
      display:flex;
      gap:6px;
      align-items:center;
    }
    .dot{
      width:10px; height:10px; border-radius:99px;
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.08);
    }
    .badge{
      font-size:11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--muted);
      font-weight:900;
    }
    .dayFooter{
      position:absolute;
      left:10px;
      bottom:8px;
      font-size:12px;
      color: var(--muted);
    }

    .modalBackdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modal{
      width: min(520px, 100%);
      border-radius: 20px;
      background: rgba(12,20,30,.95);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      padding: 16px;
      backdrop-filter: blur(14px);
    }
    .modal h4{ margin:0 0 10px; font-size:14px; color: var(--muted); letter-spacing:.06em; }
    .modal .bigDate{ font-size:20px; font-weight:900; margin-bottom: 12px; }
    .segRow{ display:flex; gap: 10px; }
    .seg{
      flex:1;
      border-radius: 16px;
      padding: 12px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      cursor:pointer;
      text-align:center;
      font-weight:900;
      color: var(--muted);
      user-select:none;
    }
    .seg.selected{
      color: var(--text);
      border-color: color-mix(in srgb, var(--accent) 55%, transparent);
      background: color-mix(in srgb, var(--accent) 14%, rgba(0,0,0,.25));
    }
    .modalActions{ display:flex; gap: 10px; justify-content:flex-end; margin-top: 12px; }

    .settingsRow{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .field{
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.08);
      padding: 10px;
    }
    .field label{ display:block; font-size:12px; color: var(--muted); font-weight:900; margin-bottom: 6px; }
    .field input{
      width:100%;
      font-size:16px;
      font-weight:900;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline:none;
    }

    @media (max-width: 940px){
      .kpis{ grid-template-columns: repeat(2, 1fr); }
      .gridDrinks{ grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 520px){
      .titleBlock .big{ font-size:40px; }
      .gridDrinks{ grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>

<body data-status="ok">
  <div class="wrap">
    <div class="topCard">
      <div class="row between">
        <div class="titleBlock">
          <div class="small">Today</div>
          <div class="big" id="todayCount">0</div>
          <div class="small" id="todayDate">----</div>
        </div>
        <div class="row" style="justify-content:flex-end">
          <span class="pill" id="ratePill">åˆ†è§£é€Ÿåº¦: 7 g/æ™‚</span>
          <button class="btn ghost" id="openSettings">è¨­å®š</button>
          <button class="btn ghost" id="resetToday">ä»Šæ—¥ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>

      <div class="kpis">
        <div class="kpi">
          <div class="label">ç›´è¿‘ã®å…¥åŠ›æ™‚åˆ»</div>
          <div class="value" id="lastTime">--:--</div>
          <div class="sub muted" id="lastTimeSub">--</div>
        </div>
        <div class="kpi">
          <div class="label">å‰å›ã‹ã‚‰ã®çµŒé</div>
          <div class="value" id="elapsed">--</div>
          <div class="sub muted" id="elapsedSub">--</div>
        </div>
        <div class="kpi">
          <div class="label">ä»Šæ—¥ã®ç´¯è¨ˆã‚¢ãƒ«ã‚³ãƒ¼ãƒ«</div>
          <div class="value" id="totalG">0.0 g</div>
          <div class="sub muted" id="totalGSub">--</div>
        </div>
        <div class="kpi">
          <div class="label">æ¶ˆè²»å®Œäº†äºˆå®š</div>
          <div class="value" id="finishAt">--:--</div>
          <div class="sub muted" id="finishAtSub">--</div>
        </div>
      </div>

      <div class="statusBar" id="statusBar">
        <div class="main" id="statusMain">OKï¼ˆã¾ã ä½™è£•ï¼‰</div>
        <div class="note" id="statusNote">
          ç›®å®‰: ç´”ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«(g) = ml Ã— åº¦æ•° Ã— 0.789 / 100ã€‚åˆ†è§£é€Ÿåº¦ã¯è¨­å®šã§å¤‰æ›´ã§ãã¾ã™ã€‚
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="panelHeader">
        <h3>ç™»éŒ²ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ã§é¸ã¶ï¼‰</h3>
        <span class="pill" id="oneDrinkPill">1æ¯ã®ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«: -- g</span>
      </div>

      <div class="gridDrinks" id="drinkGrid"></div>

      <div class="panelHeader" style="margin-top:12px">
        <h3>é‡</h3>
        <span class="pill">Sï¼ˆãƒŸãƒ‹ï¼‰/ Mï¼ˆã‚¸ãƒ§ãƒƒã‚­ï¼‰/ Lï¼ˆãƒ¡ã‚¬orç“¶ï¼‰</span>
      </div>
      <div class="gridSizes" id="sizeGrid"></div>

      <div class="actions">
        <button class="btn primary" id="addBtn">ï¼‹ è¿½åŠ </button>
        <button class="btn ghost" id="undoBtn">å–ã‚Šæ¶ˆã—</button>
      </div>
    </div>

    <div class="panel">
      <div class="panelHeader">
        <h3>Logï¼ˆä»Šæ—¥ï¼‰</h3>
        <button class="btn danger" id="clearLog">ãƒ­ã‚°æ¶ˆå»</button>
      </div>

      <div class="logWrap">
        <table>
          <thead>
            <tr>
              <th style="width:90px">æ™‚åˆ»</th>
              <th>å†…å®¹</th>
              <th class="right" style="width:90px">g</th>
              <th class="center" style="width:90px">å‰å›ã‹ã‚‰</th>
              <th class="center" style="width:90px">å‰Šé™¤</th>
            </tr>
          </thead>
          <tbody id="logBody">
            <tr><td colspan="5" class="muted">ï¼ˆno logï¼‰</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="panel">
      <div class="panelHeader">
        <h3>Logï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼‰</h3>
        <span class="pill">â—ï¼é…’é‡ï¼ˆç·‘/é»„/èµ¤ï¼‰ã€€æ•°å­—ï¼äºŒæ—¥é…”ã„ï¼ˆ0ã€œ3ï¼‰ã€€ã‚¿ãƒƒãƒ—ã§å…¥åŠ›</span>
      </div>

      <div class="calHeader">
        <div class="monthLabel" id="monthLabel">----</div>
        <div class="row" style="gap:10px">
          <button class="btn ghost" id="prevMonth">â†</button>
          <button class="btn ghost" id="thisMonth">ä»Šæœˆ</button>
          <button class="btn ghost" id="nextMonth">â†’</button>
        </div>
      </div>

      <div class="calGrid" id="calDow"></div>
      <div class="calGrid" id="calGrid"></div>
    </div>
  </div>

  <!-- Modal: hangover input -->
  <div class="modalBackdrop" id="modalBackdrop">
    <div class="modal">
      <h4>äºŒæ—¥é…”ã„ï¼ˆ0ã€œ3ï¼‰</h4>
      <div class="bigDate" id="modalDate">----</div>
      <div class="segRow" id="hangoverSeg"></div>
      <div class="modalActions">
        <button class="btn ghost" id="modalCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn primary" id="modalSave">ä¿å­˜</button>
        <button class="btn danger" id="modalClear">æ¶ˆå»</button>
      </div>
    </div>
  </div>

  <!-- Modal: settings -->
  <div class="modalBackdrop" id="settingsBackdrop">
    <div class="modal">
      <h4>è¨­å®š</h4>
      <div class="bigDate">ã—ãã„å€¤ï¼†åˆ†è§£é€Ÿåº¦</div>

      <div class="settingsRow">
        <div class="field">
          <label>é©é‡ï¼ˆgä»¥ä¸Šã§è‰²å¤‰åŒ–ï¼‰</label>
          <input id="thOk" type="number" min="0" step="1" />
        </div>
        <div class="field">
          <label>æ³¨æ„ï¼ˆgä»¥ä¸Šã§è‰²å¤‰åŒ–ï¼‰</label>
          <input id="thWarn" type="number" min="0" step="1" />
        </div>
        <div class="field">
          <label>ä¸Šé™ï¼ˆgä»¥ä¸Šã§STOPï¼‰</label>
          <input id="thStop" type="number" min="0" step="1" />
        </div>
      </div>

      <div class="settingsRow" style="grid-template-columns: 1fr 1fr;">
        <div class="field">
          <label>åˆ†è§£é€Ÿåº¦ï¼ˆg/æ™‚ï¼‰</label>
          <input id="rate" type="number" min="1" step="0.5" />
        </div>
        <div class="field">
          <label>é£²ã¿ä¼šã®ç›®å®‰ï¼ˆä»»æ„ï¼šé‹è»¢ã¯è‡ªå·±è²¬ä»»ï¼‰</label>
          <input id="noteDrive" type="text" placeholder="ä¾‹ï¼šé‹è»¢ã¯ç¿Œæœä»¥é™" />
        </div>
      </div>

      <div class="modalActions">
        <button class="btn ghost" id="settingsCancel">é–‰ã˜ã‚‹</button>
        <button class="btn primary" id="settingsSave">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script>
    // ====== Data Model ======
    const DRINKS = [
      { key:"beer",     name:"ãƒ“ãƒ¼ãƒ«",     emoji:"ğŸº", abv:5.0 },
      { key:"highball", name:"ãƒã‚¤ãƒœãƒ¼ãƒ«", emoji:"ğŸ¥ƒ", abv:7.0 },
      { key:"wine",     name:"ãƒ¯ã‚¤ãƒ³",     emoji:"ğŸ·", abv:12.0 },
      { key:"craft",    name:"ã‚¯ãƒ©ãƒ•ãƒˆ",   emoji:"ğŸºâœ¨", abv:6.5 },
      { key:"brandy",   name:"ãƒ–ãƒ©ãƒ³ãƒ‡ãƒ¼", emoji:"ğŸ¥ƒâœ¨", abv:40.0 },
    ];

    // ã‚µã‚¤ã‚ºï¼ˆã‚ãªãŸã®UIã«åˆã‚ã›ã¦ï¼šS=250 / M=350 / L=500ï¼‰
    const SIZES = [
      { key:"S", label:"Sï¼ˆãƒŸãƒ‹ï¼‰", ml:250 },
      { key:"M", label:"Mï¼ˆã‚¸ãƒ§ãƒƒã‚­ï¼‰", ml:350 },
      { key:"L", label:"Lï¼ˆãƒ¡ã‚¬/ç“¶ï¼‰", ml:500 },
    ];

    // storage keys
    const LS = {
      settings: "dc_settings_v2",
      logs: "dc_logs_v2",          // { "YYYY-MM-DD": [ {ts, drinkKey, sizeKey, ml, abv, g} ] }
      hangover: "dc_hangover_v2",  // { "YYYY-MM-DD": 0..3 }
      calendarMonth: "dc_calendar_month_v2"
    };

    function todayKey(d=new Date()){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
    function fmtHM(d){
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `${hh}:${mm}`;
    }
    function fmtYMDJP(ymd){
      const [y,m,d] = ymd.split("-");
      return `${y}å¹´${Number(m)}æœˆ${Number(d)}æ—¥`;
    }
    function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

    function loadSettings(){
      const def = {
        thOk: 20,    // é©é‡
        thWarn: 50,  // æ³¨æ„
        thStop: 80,  // ä¸Šé™
        rate: 7,     // g/æ™‚ï¼ˆå®‰å…¨å¯„ã‚Šï¼‰
        noteDrive: ""
      };
      try{
        const x = JSON.parse(localStorage.getItem(LS.settings) || "null");
        if(!x) return def;
        return { ...def, ...x };
      }catch(e){ return def; }
    }
    function saveSettings(s){
      localStorage.setItem(LS.settings, JSON.stringify(s));
    }

    function loadLogs(){
      try{
        return JSON.parse(localStorage.getItem(LS.logs) || "{}");
      }catch(e){ return {}; }
    }
    function saveLogs(all){
      localStorage.setItem(LS.logs, JSON.stringify(all));
    }

    function loadHangover(){
      try{
        return JSON.parse(localStorage.getItem(LS.hangover) || "{}");
      }catch(e){ return {}; }
    }
    function saveHangover(all){
      localStorage.setItem(LS.hangover, JSON.stringify(all));
    }

    function pureAlcoholG(ml, abv){
      // ç´”ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«(g) = ml Ã— åº¦æ•° Ã— 0.789 / 100
      return (ml * abv * 0.789 / 100);
    }

    // ====== State ======
    let settings = loadSettings();
    let logsByDay = loadLogs();
    let hangoverByDay = loadHangover();

    let selectedDrinkKey = "highball";
    let selectedSizeKey = "M";
    let lastAddedId = null;

    // Calendar state
    let calCursor = (() => {
      const saved = localStorage.getItem(LS.calendarMonth);
      if(saved){
        const [y,m] = saved.split("-").map(Number);
        if(y && m) return new Date(y, m-1, 1);
      }
      const now = new Date();
      return new Date(now.getFullYear(), now.getMonth(), 1);
    })();

    // ====== Elements ======
    const elTodayCount = document.getElementById("todayCount");
    const elTodayDate  = document.getElementById("todayDate");
    const elRatePill   = document.getElementById("ratePill");

    const elLastTime   = document.getElementById("lastTime");
    const elLastTimeSub= document.getElementById("lastTimeSub");
    const elElapsed    = document.getElementById("elapsed");
    const elElapsedSub = document.getElementById("elapsedSub");
    const elTotalG     = document.getElementById("totalG");
    const elTotalGSub  = document.getElementById("totalGSub");
    const elFinishAt   = document.getElementById("finishAt");
    const elFinishAtSub= document.getElementById("finishAtSub");

    const elStatusMain = document.getElementById("statusMain");
    const elOneDrinkPill = document.getElementById("oneDrinkPill");

    const elDrinkGrid  = document.getElementById("drinkGrid");
    const elSizeGrid   = document.getElementById("sizeGrid");
    const elLogBody    = document.getElementById("logBody");

    const btnAdd = document.getElementById("addBtn");
    const btnUndo= document.getElementById("undoBtn");
    const btnResetToday = document.getElementById("resetToday");
    const btnClearLog = document.getElementById("clearLog");

    // modal hangover
    const modalBackdrop = document.getElementById("modalBackdrop");
    const elModalDate = document.getElementById("modalDate");
    const elHangoverSeg = document.getElementById("hangoverSeg");
    const btnModalCancel = document.getElementById("modalCancel");
    const btnModalSave = document.getElementById("modalSave");
    const btnModalClear = document.getElementById("modalClear");
    let modalTargetDay = null;
    let modalSelectedHangover = null;

    // settings modal
    const btnOpenSettings = document.getElementById("openSettings");
    const settingsBackdrop = document.getElementById("settingsBackdrop");
    const inputThOk = document.getElementById("thOk");
    const inputThWarn = document.getElementById("thWarn");
    const inputThStop = document.getElementById("thStop");
    const inputRate = document.getElementById("rate");
    const inputNoteDrive = document.getElementById("noteDrive");
    const btnSettingsCancel = document.getElementById("settingsCancel");
    const btnSettingsSave = document.getElementById("settingsSave");

    // calendar elements
    const elMonthLabel = document.getElementById("monthLabel");
    const elCalDow = document.getElementById("calDow");
    const elCalGrid = document.getElementById("calGrid");
    const btnPrevMonth = document.getElementById("prevMonth");
    const btnNextMonth = document.getElementById("nextMonth");
    const btnThisMonth = document.getElementById("thisMonth");

    // ====== Renderers ======
    function renderDrinkTiles(){
      elDrinkGrid.innerHTML = "";
      DRINKS.forEach(d => {
        const div = document.createElement("div");
        div.className = "tile" + (d.key === selectedDrinkKey ? " selected" : "");
        div.innerHTML = `
          <div class="emoji">${d.emoji}</div>
          <div class="name">${d.name}</div>
          <div class="abv">${d.abv}%</div>
        `;
        div.onclick = () => {
          selectedDrinkKey = d.key;
          renderDrinkTiles();
          renderOneDrink();
        };
        elDrinkGrid.appendChild(div);
      });
    }

    function renderSizeTiles(){
      elSizeGrid.innerHTML = "";
      SIZES.forEach(s => {
        const div = document.createElement("div");
        div.className = "sizeTile" + (s.key === selectedSizeKey ? " selected" : "");
        div.innerHTML = `
          <div class="name">${s.label}</div>
          <div class="ml">${s.ml} ml</div>
        `;
        div.onclick = () => {
          selectedSizeKey = s.key;
          renderSizeTiles();
          renderOneDrink();
        };
        elSizeGrid.appendChild(div);
      });
    }

    function getTodayLogs(){
      const key = todayKey();
      return logsByDay[key] || [];
    }

    function renderTop(){
      const key = todayKey();
      const now = new Date();
      const logs = getTodayLogs();

      elTodayDate.textContent = key;
      elTodayCount.textContent = String(logs.length);

      elRatePill.textContent = `åˆ†è§£é€Ÿåº¦: ${settings.rate} g/æ™‚`;

      // totals
      const totalG = logs.reduce((a,x)=>a + x.g, 0);
      elTotalG.textContent = `${totalG.toFixed(1)} g`;
      elTotalGSub.textContent = `ã—ãã„å€¤: é©é‡${settings.thOk} / æ³¨æ„${settings.thWarn} / ä¸Šé™${settings.thStop} g`;

      // last time & elapsed
      if(logs.length === 0){
        elLastTime.textContent = "--:--";
        elLastTimeSub.textContent = "ï¼ˆå…¥åŠ›ãªã—ï¼‰";
        elElapsed.textContent = "--";
        elElapsedSub.textContent = "--";
      }else{
        const last = logs[logs.length - 1];
        const lastDate = new Date(last.ts);
        elLastTime.textContent = fmtHM(lastDate);
        elLastTimeSub.textContent = fmtYMDJP(key);

        const diffMin = Math.max(0, Math.round((now - lastDate)/60000));
        elElapsed.textContent = `${diffMin}åˆ†`;
        elElapsedSub.textContent = diffMin < 60 ? "â€”" : `${Math.floor(diffMin/60)}æ™‚é–“${diffMin%60}åˆ†`;
      }

      // finish time estimate
      const hours = totalG / Math.max(0.1, settings.rate);
      const finish = new Date(now.getTime() + hours * 3600 * 1000);
      elFinishAt.textContent = logs.length ? fmtHM(finish) : "--:--";
      elFinishAtSub.textContent = logs.length ? `ç´„${Math.ceil(hours*60)}åˆ†å¾Œã«æ¶ˆè²»ç›®å®‰` : "â€”";

      // status + theme
      const status = calcStatus(totalG);
      applyStatusTheme(status.key);
      elStatusMain.textContent = status.label;
    }

    function calcStatus(totalG){
      // 3æ®µéš
      // ok: < warn, warn: >= warn && < stop, stop: >= stop
      if(totalG >= settings.thStop){
        return { key:"stop", label:"ä¸Šé™åˆ°é”ï¼ˆã“ã‚Œä»¥ä¸Šã¯å±é™ºï¼‰" };
      }
      if(totalG >= settings.thWarn){
        return { key:"warn", label:"æ³¨æ„ï¼ˆã“ã“ã‹ã‚‰å…ˆã¯å±é™ºåŸŸã«è¿‘ã„ï¼‰" };
      }
      return { key:"ok", label:"OKï¼ˆã¾ã ä½™è£•ï¼‰" };
    }

    function applyStatusTheme(statusKey){
      document.body.dataset.status = statusKey; // ok / warn / stop
      // theme-color ã‚‚å¤‰ãˆã‚‹ï¼ˆSafari/Chromeã®UIè‰²ãŒå°‘ã—é¦´æŸ“ã‚€ï¼‰
      const meta = document.querySelector('meta[name="theme-color"]');
      if(meta){
        const c = statusKey === "stop" ? "#1b0a0c" : (statusKey === "warn" ? "#1a1408" : "#071428");
        meta.setAttribute("content", c);
      }
    }

    function renderOneDrink(){
      const d = DRINKS.find(x=>x.key===selectedDrinkKey);
      const s = SIZES.find(x=>x.key===selectedSizeKey);
      const g = pureAlcoholG(s.ml, d.abv);
      elOneDrinkPill.textContent = `1æ¯ã®ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«: ${g.toFixed(1)} g`;
    }

    function renderLogTable(){
      const logs = getTodayLogs();
      if(logs.length === 0){
        elLogBody.innerHTML = `<tr><td colspan="5" class="muted">ï¼ˆno logï¼‰</td></tr>`;
        return;
      }

      let html = "";
      for(let i=0; i<logs.length; i++){
        const x = logs[i];
        const t = new Date(x.ts);
        const hm = fmtHM(t);
        const drink = DRINKS.find(d=>d.key===x.drinkKey);
        const size  = SIZES.find(s=>s.key===x.sizeKey);

        let prev = "--";
        if(i>0){
          const prevTs = logs[i-1].ts;
          const diffMin = Math.max(0, Math.round((x.ts - prevTs)/60000));
          prev = `${diffMin}åˆ†`;
        }

        html += `
          <tr>
            <td>${hm}</td>
            <td>${drink.emoji} ${drink.name} / ${size.key} (${x.ml}mlãƒ»${x.abv}%)</td>
            <td class="right"><b>${x.g.toFixed(1)}</b> g</td>
            <td class="center">${prev}</td>
            <td class="center"><button class="miniBtn danger" data-del="${x.id}">å‰Šé™¤</button></td>
          </tr>
        `;
      }
      elLogBody.innerHTML = html;

      // bind delete
      [...elLogBody.querySelectorAll("button[data-del]")].forEach(btn=>{
        btn.onclick = () => {
          const id = btn.getAttribute("data-del");
          deleteLogById(id);
        };
      });
    }

    function renderCalendar(){
      // store cursor
      localStorage.setItem(LS.calendarMonth, `${calCursor.getFullYear()}-${String(calCursor.getMonth()+1).padStart(2,"0")}`);

      const y = calCursor.getFullYear();
      const m = calCursor.getMonth(); // 0-based
      elMonthLabel.textContent = `${y}å¹´${m+1}æœˆ`;

      // dow
      const dows = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
      elCalDow.innerHTML = dows.map(x=>`<div class="dow">${x}</div>`).join("");

      // grid: start day
      const first = new Date(y, m, 1);
      const startDow = first.getDay();
      const daysInMonth = new Date(y, m+1, 0).getDate();

      // build cells with blanks
      const cells = [];
      for(let i=0;i<startDow;i++){
        cells.push({ blank:true });
      }
      for(let d=1; d<=daysInMonth; d++){
        const date = new Date(y, m, d);
        const key = todayKey(date);
        cells.push({ blank:false, key, d });
      }

      // render
      elCalGrid.innerHTML = "";
      cells.forEach(c=>{
        if(c.blank){
          const div = document.createElement("div");
          div.style.visibility="hidden";
          div.className="dayCell";
          elCalGrid.appendChild(div);
          return;
        }

        const dayLogs = logsByDay[c.key] || [];
        const totalG = dayLogs.reduce((a,x)=>a+x.g,0);
        const st = calcStatus(totalG);
        const hang = hangoverByDay[c.key]; // 0..3 or undefined

        // dot color by status
        const dotColor = st.key==="stop" ? "rgba(255,59,48,.85)" : (st.key==="warn" ? "rgba(255,176,32,.85)" : (dayLogs.length ? "rgba(36,209,143,.85)" : "rgba(255,255,255,.08)"));

        const div = document.createElement("div");
        div.className = "dayCell";
        div.innerHTML = `
          <div class="dayNum">${c.d}</div>
          <div class="badges">
            <span class="dot" style="background:${dotColor}"></span>
            ${Number.isFinite(hang) ? `<span class="badge">${hang}</span>` : ``}
          </div>
          <div class="dayFooter">${dayLogs.length ? `${totalG.toFixed(0)}g` : ""}</div>
        `;
        div.onclick = () => openHangoverModal(c.key);
        elCalGrid.appendChild(div);
      });
    }

    // ====== Actions ======
    function addLog(){
      const d = DRINKS.find(x=>x.key===selectedDrinkKey);
      const s = SIZES.find(x=>x.key===selectedSizeKey);
      const ts = Date.now();
      const g = pureAlcoholG(s.ml, d.abv);

      const item = {
        id: `${ts}_${Math.random().toString(16).slice(2)}`,
        ts,
        drinkKey: d.key,
        sizeKey: s.key,
        ml: s.ml,
        abv: d.abv,
        g
      };

      const key = todayKey();
      logsByDay[key] = logsByDay[key] || [];
      logsByDay[key].push(item);
      saveLogs(logsByDay);

      lastAddedId = item.id;

      refreshAll();
    }

    function undoLast(){
      if(!lastAddedId) return;
      deleteLogById(lastAddedId);
      lastAddedId = null;
    }

    function deleteLogById(id){
      const key = todayKey();
      const logs = logsByDay[key] || [];
      const idx = logs.findIndex(x=>x.id===id);
      if(idx >= 0){
        logs.splice(idx,1);
        logsByDay[key] = logs;
        saveLogs(logsByDay);
        refreshAll();
      }
    }

    function resetToday(){
      const key = todayKey();
      if(confirm("ä»Šæ—¥ã®ãƒ­ã‚°ã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")){
        delete logsByDay[key];
        saveLogs(logsByDay);
        lastAddedId = null;
        refreshAll();
      }
    }

    function clearAllLogs(){
      if(confirm("å…¨ãƒ­ã‚°ï¼ˆä»Šæ—¥ã®ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿï¼ˆä»Šæ—¥ã®ã¿ï¼‰")){
        resetToday();
      }
    }

    // ====== Hangover modal ======
    function openHangoverModal(dayKey){
      modalTargetDay = dayKey;
      modalSelectedHangover = Number.isFinite(hangoverByDay[dayKey]) ? hangoverByDay[dayKey] : null;

      elModalDate.textContent = fmtYMDJP(dayKey);

      // build segments 0..3
      const labels = ["0ï¼ˆãªã—ï¼‰","1ï¼ˆè»½ã„ï¼‰","2ï¼ˆä¸­ï¼‰","3ï¼ˆé‡ã„ï¼‰"];
      elHangoverSeg.innerHTML = "";
      for(let i=0;i<=3;i++){
        const seg = document.createElement("div");
        seg.className = "seg" + (modalSelectedHangover===i ? " selected" : "");
        seg.textContent = labels[i];
        seg.onclick = () => {
          modalSelectedHangover = i;
          [...elHangoverSeg.querySelectorAll(".seg")].forEach(x=>x.classList.remove("selected"));
          seg.classList.add("selected");
        };
        elHangoverSeg.appendChild(seg);
      }

      modalBackdrop.style.display = "flex";
    }
    function closeHangoverModal(){
      modalBackdrop.style.display = "none";
      modalTargetDay = null;
      modalSelectedHangover = null;
    }

    btnModalCancel.onclick = closeHangoverModal;
    modalBackdrop.onclick = (e)=>{ if(e.target === modalBackdrop) closeHangoverModal(); };

    btnModalSave.onclick = () => {
      if(!modalTargetDay) return;
      if(modalSelectedHangover === null){
        alert("0ã€œ3ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚");
        return;
      }
      hangoverByDay[modalTargetDay] = modalSelectedHangover;
      saveHangover(hangoverByDay);
      closeHangoverModal();
      renderCalendar();
    };

    btnModalClear.onclick = () => {
      if(!modalTargetDay) return;
      delete hangoverByDay[modalTargetDay];
      saveHangover(hangoverByDay);
      closeHangoverModal();
      renderCalendar();
    };

    // ====== Settings modal ======
    function openSettings(){
      inputThOk.value = settings.thOk;
      inputThWarn.value = settings.thWarn;
      inputThStop.value = settings.thStop;
      inputRate.value = settings.rate;
      inputNoteDrive.value = settings.noteDrive || "";
      settingsBackdrop.style.display = "flex";
    }
    function closeSettings(){
      settingsBackdrop.style.display = "none";
    }
    btnOpenSettings.onclick = openSettings;
    btnSettingsCancel.onclick = closeSettings;
    settingsBackdrop.onclick = (e)=>{ if(e.target === settingsBackdrop) closeSettings(); };

    btnSettingsSave.onclick = () => {
      const thOk = Number(inputThOk.value);
      const thWarn = Number(inputThWarn.value);
      const thStop = Number(inputThStop.value);
      const rate = Number(inputRate.value);

      if(!(thOk>=0 && thWarn>=0 && thStop>=0 && rate>0)){
        alert("æ•°å€¤ãŒä¸æ­£ã§ã™ã€‚");
        return;
      }
      // è‡ªç„¶ãªä¸¦ã³ã«è£œæ­£ï¼ˆOK <= WARN <= STOPï¼‰
      const a = clamp(thOk, 0, 9999);
      const b = clamp(thWarn, a, 9999);
      const c = clamp(thStop, b, 9999);

      settings = {
        thOk: a,
        thWarn: b,
        thStop: c,
        rate: clamp(rate, 1, 50),
        noteDrive: String(inputNoteDrive.value || "")
      };
      saveSettings(settings);
      closeSettings();
      refreshAll();
    };

    // ====== Calendar controls ======
    btnPrevMonth.onclick = () => { calCursor = new Date(calCursor.getFullYear(), calCursor.getMonth()-1, 1); renderCalendar(); };
    btnNextMonth.onclick = () => { calCursor = new Date(calCursor.getFullYear(), calCursor.getMonth()+1, 1); renderCalendar(); };
    btnThisMonth.onclick = () => {
      const now = new Date();
      calCursor = new Date(now.getFullYear(), now.getMonth(), 1);
      renderCalendar();
    };

    // ====== Bind ======
    btnAdd.onclick = addLog;
    btnUndo.onclick = undoLast;
    btnResetToday.onclick = resetToday;
    btnClearLog.onclick = clearAllLogs;

    // ====== Refresh ======
    function refreshAll(){
      renderTop();
      renderOneDrink();
      renderLogTable();
      renderCalendar();
    }

    // Tick updates (elapsed/finish time)
    setInterval(()=> {
      renderTop();
    }, 15000);

    // ====== Init ======
    function init(){
      renderDrinkTiles();
      renderSizeTiles();
      refreshAll();

      // PWA service worker (æ—¢å­˜sw.jsãŒã‚ã‚‹å ´åˆã®ã¿)
      if("serviceWorker" in navigator){
        navigator.serviceWorker.register("./sw.js").catch(()=>{});
      }
    }
    init();
  </script>
</body>
</html>
