<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <link rel="manifest" href="manifest.webmanifest" />
  <title>Drink Counter</title>
  <style>
    :root{
      --bg:#07101d;
      --card:#0d1b2a;
      --card2:#0b1625;
      --text:#e8eef9;
      --muted:#9fb1c8;
      --accent:#2b6cff;
      --danger:#b91c1c;
      --warn:#b45309;
      --ok:#15803d;
      --line:rgba(255,255,255,.08);
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:linear-gradient(180deg,#061026,#050b16);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif;
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 40px}
    .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:14px;
      padding:18px; border-radius:var(--radius); background:rgba(255,255,255,.03);
      box-shadow:var(--shadow); border:1px solid var(--line);
    }
    .today{
      display:flex; flex-direction:column; gap:6px;
    }
    .today .n{font-size:56px; font-weight:800; line-height:1}
    .today .d{color:var(--muted); font-size:14px}
    .btnrow{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      border:1px solid var(--line); background:rgba(255,255,255,.04);
      color:var(--text); padding:10px 12px; border-radius:999px; cursor:pointer;
      font-weight:700;
    }
    .btn.primary{background:rgba(43,108,255,.18); border-color:rgba(43,108,255,.35)}
    .btn.danger{background:rgba(185,28,28,.18); border-color:rgba(185,28,28,.35)}
    .grid4{
      margin-top:14px;
      display:grid; grid-template-columns:repeat(4,1fr); gap:10px;
    }
    .card{
      padding:14px; border-radius:var(--radius);
      background:rgba(255,255,255,.03); border:1px solid var(--line); box-shadow:var(--shadow);
      min-height:74px;
    }
    .card .k{font-size:12px; color:var(--muted)}
    .card .v{font-size:22px; font-weight:800; margin-top:6px}
    .status{
      margin-top:10px;
      padding:12px 14px; border-radius:14px;
      border:1px solid var(--line);
      font-weight:800;
    }
    .status.ok{background:rgba(21,128,61,.18); border-color:rgba(21,128,61,.35)}
    .status.warn{background:rgba(180,83,9,.18); border-color:rgba(180,83,9,.35)}
    .status.danger{background:rgba(185,28,28,.18); border-color:rgba(185,28,28,.35)}
    .hint{margin-top:8px; font-size:12px; color:var(--muted)}
    .section{
      margin-top:14px; padding:16px; border-radius:var(--radius);
      background:rgba(255,255,255,.03); border:1px solid var(--line); box-shadow:var(--shadow);
    }
    .section h3{margin:0 0 12px; font-size:14px; color:var(--muted); letter-spacing:.02em}
    .drink-grid{
      display:grid; grid-template-columns:repeat(5,1fr); gap:10px;
    }
    .drink{
      padding:14px; border-radius:16px; border:1px solid var(--line);
      background:rgba(255,255,255,.02); cursor:pointer; text-align:center;
    }
    .drink.sel{outline:2px solid rgba(43,108,255,.5); background:rgba(43,108,255,.10)}
    .drink .emoji{font-size:22px}
    .drink .name{margin-top:6px; font-weight:900}
    .drink .abv{margin-top:4px; font-size:12px; color:var(--muted)}
    .size-grid{
      display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:12px;
    }
    .sz{
      padding:14px; border-radius:16px; border:1px solid var(--line);
      background:rgba(255,255,255,.02); cursor:pointer; text-align:center;
      font-weight:900;
    }
    .sz.sel{outline:2px solid rgba(43,108,255,.5); background:rgba(43,108,255,.10)}
    .sz small{display:block; margin-top:6px; color:var(--muted); font-weight:600}
    .actions{
      display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;
    }
    .actions .btn{border-radius:14px; padding:12px 14px}
    table{width:100%; border-collapse:collapse; font-size:13px}
    th,td{padding:10px 8px; border-bottom:1px solid var(--line); color:var(--text)}
    th{color:var(--muted); text-align:left; font-weight:800}
    td.right{text-align:right}
    .pill{
      padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.04); border:1px solid var(--line);
      font-size:12px; color:var(--muted); font-weight:800;
    }
    .modal-back{
      position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center;
      padding:18px;
    }
    .modal{
      width:min(560px,100%);
      background:rgba(12,22,36,.98);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:0 20px 60px rgba(0,0,0,.55);
      padding:16px;
    }
    .modal h2{margin:0 0 12px; font-size:16px}
    .form{
      display:grid; grid-template-columns:1fr 1fr; gap:10px;
    }
    .field{
      background:rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
    }
    .field label{display:block; font-size:12px; color:var(--muted); font-weight:800; margin-bottom:8px}
    .field input{
      width:100%; padding:12px 12px; border-radius:12px; border:1px solid var(--line);
      background:rgba(0,0,0,.2); color:var(--text); font-size:16px; font-weight:800;
    }
    .modal .actions{justify-content:flex-end}
    @media (max-width:820px){
      .grid4{grid-template-columns:repeat(2,1fr)}
      .drink-grid{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>
<div class="wrap">

  <div class="top">
    <div class="today">
      <div class="k">Today</div>
      <div class="n" id="todayCount">0</div>
      <div class="d" id="todayDate">--</div>
    </div>
    <div class="btnrow">
      <button class="btn primary" id="openSettings">è¨­å®š</button>
      <span class="pill" id="ratePill">åˆ†è§£é€Ÿåº¦: 7 g/æ™‚</span>
      <button class="btn danger" id="resetToday">ä»Šæ—¥ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>

  <div class="grid4">
    <div class="card"><div class="k">ç›´è¿‘ã®å…¥åŠ›æ™‚åˆ»</div><div class="v" id="lastTime">--:--</div></div>
    <div class="card"><div class="k">å‰å›ã‹ã‚‰ã®çµŒé</div><div class="v" id="sinceLast">--</div></div>
    <div class="card"><div class="k">ä»Šæ—¥ã®ç´¯è¨ˆã‚¢ãƒ«ã‚³ãƒ¼ãƒ«</div><div class="v" id="todayGrams">0.0 g</div></div>
    <div class="card"><div class="k">åˆ†è§£å®Œäº†äºˆå®š</div><div class="v" id="finishAt">--:--</div></div>
  </div>

  <div class="status ok" id="statusBar">OKï¼ˆã¾ã ä½™è£•ï¼‰</div>
  <div class="hint" id="hintText">
    ç›®å®‰ï¼šç´”ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«(g) = ml Ã— åº¦æ•° Ã— 0.789 / 100ï¼ˆè¨­å®šã§åˆ†è§£é€Ÿåº¦ãƒ»ã—ãã„å€¤ã‚’å¤‰æ›´ã§ãã¾ã™ï¼‰
  </div>

  <div class="section">
    <h3>ç™»éŒ²ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ã§é¸ã¶ï¼‰</h3>
    <div class="drink-grid" id="drinkGrid"></div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;gap:10px;flex-wrap:wrap">
      <div class="pill" id="oneCupPill">1æ¯ã®ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«: 0.0 g</div>
      <div class="pill">Sï¼ˆãƒŸãƒ‹ï¼‰/ Mï¼ˆã‚¸ãƒ§ãƒƒã‚­ï¼‰/ Lï¼ˆãƒ¡ã‚¬ or ç“¶ï¼‰</div>
    </div>

    <div class="size-grid" id="sizeGrid"></div>

    <div class="actions">
      <button class="btn primary" id="addBtn">ï¼‹ è¿½åŠ </button>
      <button class="btn" id="undoBtn">å–ã‚Šæ¶ˆã—</button>
    </div>
  </div>

  <div class="section">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <h3 style="margin:0">Logï¼ˆä»Šæ—¥ï¼‰</h3>
      <button class="btn danger" id="clearLog">ãƒ­ã‚°æ¶ˆå»</button>
    </div>
    <div style="overflow:auto;margin-top:8px">
      <table>
        <thead>
          <tr>
            <th>æ™‚åˆ»</th>
            <th>å†…å®¹</th>
            <th class="right">g</th>
            <th class="right">å‰å›ã‹ã‚‰</th>
            <th class="right">å‰Šé™¤</th>
          </tr>
        </thead>
        <tbody id="logBody"></tbody>
      </table>
    </div>
  </div>

  <div class="section" id="calendarSection" style="display:none">
    <!-- Phase2ä»¥é™ã§ä½¿ã†äºˆå®šã€‚ä»Šã¯æ¸©å­˜ -->
  </div>

</div>

<!-- Settings Modal -->
<div class="modal-back" id="modalBack" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="è¨­å®š">
    <h2>è¨­å®šï¼ˆã—ãã„å€¤ï¼†åˆ†è§£é€Ÿåº¦ï¼‰</h2>
    <div class="form">
      <div class="field">
        <label>åˆ†è§£é€Ÿåº¦ï¼ˆg/æ™‚ï¼‰</label>
        <input type="number" id="setRate" step="0.1" min="1" max="20" />
      </div>
      <div class="field">
        <label>é©é‡ï¼ˆgè¶…ã§è¡¨ç¤ºãŒå¤‰ã‚ã‚‹ï¼‰</label>
        <input type="number" id="thOk" step="1" min="0" />
      </div>
      <div class="field">
        <label>æ³¨æ„ï¼ˆgè¶…ã§è¡¨ç¤ºãŒå¤‰ã‚ã‚‹ï¼‰</label>
        <input type="number" id="thWarn" step="1" min="0" />
      </div>
      <div class="field">
        <label>ä¸Šé™ï¼ˆgè¶…ã§ STOPï¼‰</label>
        <input type="number" id="thStop" step="1" min="0" />
      </div>
    </div>
    <div class="hint" style="margin-top:10px">
      â€»å€¤ã¯ç«¯æœ«ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆlocalStorageï¼‰ã€‚åº—ã‚„ä½“èª¿ã§èª¿æ•´ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
    </div>
    <div class="actions">
      <button class="btn" id="closeSettings">é–‰ã˜ã‚‹</button>
      <button class="btn primary" id="saveSettings">ä¿å­˜</button>
    </div>
  </div>
</div>

<script>
/** ====== PWA SW ====== */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
  });
}

/** ====== Data & Defaults ====== */
const STORAGE_KEY = "drink_counter_v2";

const DRINKS = [
  { id:"beer",     name:"ãƒ“ãƒ¼ãƒ«",     emoji:"ğŸº", abv:5.0 },
  { id:"highball", name:"ãƒã‚¤ãƒœãƒ¼ãƒ«", emoji:"ğŸ§Š", abv:7.0 },
  { id:"wine",     name:"ãƒ¯ã‚¤ãƒ³",     emoji:"ğŸ·", abv:12.0 },
  { id:"craft",    name:"ã‚¯ãƒ©ãƒ•ãƒˆ",   emoji:"ğŸºâœ¨", abv:6.5 },
  { id:"brandy",   name:"ãƒ–ãƒ©ãƒ³ãƒ‡ãƒ¼", emoji:"ğŸ¥ƒâœ¨", abv:40.0 },
];

// è¡¨ç¤ºã¯S/M/Lå›ºå®šï¼ˆè³ªå•ã®æŒ‡å®šã©ãŠã‚Šï¼‰
const SIZES = [
  { id:"S", label:"Sï¼ˆãƒŸãƒ‹ï¼‰", ml:250 },
  { id:"M", label:"Mï¼ˆã‚¸ãƒ§ãƒƒã‚­ï¼‰", ml:350 },
  { id:"L", label:"Lï¼ˆãƒ¡ã‚¬/ç“¶ï¼‰", ml:500 },
];

// åˆæœŸã®ä»®ç½®ãï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šï¼‰
const DEFAULT_SETTINGS = {
  rate_g_per_h: 7.0,
  th_ok: 30,    // ä¾‹ï¼šé©é‡ã®ä¸Š
  th_warn: 60,  // ä¾‹ï¼šæ³¨æ„
  th_stop: 90,  // ä¾‹ï¼šä¸Šé™
};

function todayKey(d = new Date()){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const da = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${da}`;
}

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return { settings:{...DEFAULT_SETTINGS}, logsByDate:{} };
    const st = JSON.parse(raw);
    // migrate / fill defaults
    st.settings = { ...DEFAULT_SETTINGS, ...(st.settings||{}) };
    st.logsByDate = st.logsByDate || {};
    return st;
  }catch{
    return { settings:{...DEFAULT_SETTINGS}, logsByDate:{} };
  }
}

function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

let state = loadState();
let selectedDrinkId = "highball";
let selectedSizeId = "M";

/** ====== Utils ====== */
function fmtTime(d){
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  return `${hh}:${mm}`;
}
function diffMin(a,b){
  const ms = a - b;
  return Math.max(0, Math.round(ms/60000));
}
function alcoholGrams(ml, abv){
  // g = ml Ã— åº¦æ•° Ã— 0.789 / 100
  return (ml * abv * 0.789) / 100.0;
}
function getTodayLogs(){
  const k = todayKey();
  return state.logsByDate[k] || [];
}
function setTodayLogs(list){
  const k = todayKey();
  state.logsByDate[k] = list;
  saveState();
}
function sumGrams(list){
  return list.reduce((s,x)=>s+(x.grams||0),0);
}
function now(){ return new Date(); }

/** ====== UI Render ====== */
const el = (id)=>document.getElementById(id);

function renderDrinkGrid(){
  const g = el("drinkGrid");
  g.innerHTML = "";
  DRINKS.forEach(d=>{
    const div = document.createElement("div");
    div.className = "drink" + (d.id===selectedDrinkId ? " sel":"");
    div.innerHTML = `
      <div class="emoji">${d.emoji}</div>
      <div class="name">${d.name}</div>
      <div class="abv">${d.abv}%</div>
    `;
    div.onclick = ()=>{ selectedDrinkId=d.id; renderAll(); };
    g.appendChild(div);
  });
}

function renderSizeGrid(){
  const g = el("sizeGrid");
  g.innerHTML = "";
  SIZES.forEach(s=>{
    const div = document.createElement("div");
    div.className = "sz" + (s.id===selectedSizeId ? " sel":"");
    div.innerHTML = `${s.label}<small>${s.ml} ml</small>`;
    div.onclick = ()=>{ selectedSizeId=s.id; renderAll(); };
    g.appendChild(div);
  });
}

function statusFor(totalG){
  const { th_ok, th_warn, th_stop } = state.settings;
  if(totalG >= th_stop) return { cls:"danger", text:"ä¸Šé™åˆ°é”ï¼ˆã“ã‚Œä»¥ä¸Šã¯å±é™ºï¼‰" };
  if(totalG >= th_warn) return { cls:"warn", text:"æ³¨æ„ï¼ˆãƒšãƒ¼ã‚¹è½ã¨ã™ï¼‰" };
  if(totalG >= th_ok) return { cls:"ok", text:"é©é‡ã‚¾ãƒ¼ãƒ³ï¼ˆã¾ã OKï¼‰" };
  return { cls:"ok", text:"OKï¼ˆã¾ã ä½™è£•ï¼‰" };
}

function computeFinishAt(totalG){
  const rate = state.settings.rate_g_per_h;
  if(totalG <= 0) return null;
  const hours = totalG / Math.max(0.1, rate);
  const ms = hours * 3600 * 1000;
  return new Date(Date.now() + ms);
}

function renderTop(){
  const t = now();
  el("todayDate").textContent = todayKey(t);

  const logs = getTodayLogs();
  el("todayCount").textContent = String(logs.length);

  const total = sumGrams(logs);
  el("todayGrams").textContent = `${total.toFixed(1)} g`;

  // last time & since last
  if(logs.length===0){
    el("lastTime").textContent = "--:--";
    el("sinceLast").textContent = "--";
  }else{
    const last = logs[logs.length-1];
    const lastD = new Date(last.ts);
    el("lastTime").textContent = fmtTime(lastD);
    const prev = logs.length>=2 ? new Date(logs[logs.length-2].ts) : null;
    el("sinceLast").textContent = prev ? `${diffMin(lastD, prev)}åˆ†` : "--";
  }

  // finish time
  const fin = computeFinishAt(total);
  el("finishAt").textContent = fin ? fmtTime(fin) : "--:--";

  // status
  const st = statusFor(total);
  const sb = el("statusBar");
  sb.className = `status ${st.cls}`;
  sb.textContent = st.text;

  // rate pill
  el("ratePill").textContent = `åˆ†è§£é€Ÿåº¦: ${state.settings.rate_g_per_h} g/æ™‚`;
}

function renderOneCup(){
  const drink = DRINKS.find(x=>x.id===selectedDrinkId);
  const size = SIZES.find(x=>x.id===selectedSizeId);
  const g = alcoholGrams(size.ml, drink.abv);
  el("oneCupPill").textContent = `1æ¯ã®ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«: ${g.toFixed(1)} g`;
}

function renderLog(){
  const logs = getTodayLogs();
  const tb = el("logBody");
  tb.innerHTML = "";

  if(logs.length===0){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="5" style="color:var(--muted);padding:14px">ï¼ˆno logï¼‰</td>`;
    tb.appendChild(tr);
    return;
  }

  logs.forEach((x,idx)=>{
    const tr = document.createElement("tr");
    const d = new Date(x.ts);
    const prev = idx>0 ? new Date(logs[idx-1].ts) : null;
    const since = prev ? `${diffMin(d, prev)}åˆ†` : "--";

    tr.innerHTML = `
      <td>${fmtTime(d)}</td>
      <td>${x.emoji} ${x.name} / ${x.sizeLabel} (${x.ml}mlãƒ»${x.abv}%)</td>
      <td class="right"><b>${(x.grams||0).toFixed(1)}</b> g</td>
      <td class="right">${since}</td>
      <td class="right"><button class="btn" style="padding:8px 10px;border-radius:12px" data-del="${idx}">å‰Šé™¤</button></td>
    `;
    tb.appendChild(tr);
  });

  tb.querySelectorAll("[data-del]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const i = Number(btn.getAttribute("data-del"));
      const logs = getTodayLogs();
      logs.splice(i,1);
      setTodayLogs(logs);
      renderAll();
    });
  });
}

function renderAll(){
  renderDrinkGrid();
  renderSizeGrid();
  renderOneCup();
  renderTop();
  renderLog();
}

/** ====== Actions ====== */
el("addBtn").addEventListener("click", ()=>{
  const drink = DRINKS.find(x=>x.id===selectedDrinkId);
  const size = SIZES.find(x=>x.id===selectedSizeId);
  const g = alcoholGrams(size.ml, drink.abv);

  const logs = getTodayLogs();
  logs.push({
    ts: Date.now(),
    drinkId: drink.id,
    name: drink.name,
    emoji: drink.emoji,
    abv: drink.abv,
    sizeId: size.id,
    sizeLabel: size.label,
    ml: size.ml,
    grams: g
  });
  setTodayLogs(logs);
  renderAll();
});

el("undoBtn").addEventListener("click", ()=>{
  const logs = getTodayLogs();
  if(logs.length===0) return;
  logs.pop();
  setTodayLogs(logs);
  renderAll();
});

el("clearLog").addEventListener("click", ()=>{
  if(!confirm("ä»Šæ—¥ã®ãƒ­ã‚°ã‚’å…¨æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) return;
  setTodayLogs([]);
  renderAll();
});

el("resetToday").addEventListener("click", ()=>{
  if(!confirm("ä»Šæ—¥ã®è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
  setTodayLogs([]);
  renderAll();
});

/** ====== Settings Modal ====== */
const modalBack = el("modalBack");
function openModal(){
  // set current values
  el("setRate").value = state.settings.rate_g_per_h;
  el("thOk").value = state.settings.th_ok;
  el("thWarn").value = state.settings.th_warn;
  el("thStop").value = state.settings.th_stop;
  modalBack.style.display = "flex";
  modalBack.setAttribute("aria-hidden","false");
}
function closeModal(){
  modalBack.style.display = "none";
  modalBack.setAttribute("aria-hidden","true");
}

el("openSettings").addEventListener("click", openModal);
el("closeSettings").addEventListener("click", closeModal);
modalBack.addEventListener("click", (e)=>{
  if(e.target === modalBack) closeModal();
});

el("saveSettings").addEventListener("click", ()=>{
  const rate = Number(el("setRate").value);
  const thOk = Number(el("thOk").value);
  const thWarn = Number(el("thWarn").value);
  const thStop = Number(el("thStop").value);

  if(!Number.isFinite(rate) || rate <= 0){
    alert("åˆ†è§£é€Ÿåº¦ï¼ˆg/æ™‚ï¼‰ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }
  // ã—ãã„å€¤ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼ˆã‚†ã‚‹ã‚ï¼‰
  if(!(thOk <= thWarn && thWarn <= thStop)){
    alert("ã—ãã„å€¤ã¯ã€Œé©é‡ â‰¤ æ³¨æ„ â‰¤ ä¸Šé™ã€ã®é †ã«ã—ã¦ãã ã•ã„");
    return;
  }

  state.settings.rate_g_per_h = Math.round(rate*10)/10;
  state.settings.th_ok = Math.round(thOk);
  state.settings.th_warn = Math.round(thWarn);
  state.settings.th_stop = Math.round(thStop);
  saveState();

  closeModal();
  renderAll();
});

/** ====== Init ====== */
renderAll();
setInterval(renderTop, 15000); // æ™‚åˆ»ç³»ã¯å®šæœŸæ›´æ–°
</script>
</body>
</html>
