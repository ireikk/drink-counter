<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Drink Counter</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b1220" />
  <style>
    :root{
      --bg:#0b1220; --card:#0f1a2e;
      --text:#e8eefc; --muted:#a8b3cc;
      --btn:#1f6feb; --btn2:#27324a; --danger:#b42318;
      --ring: rgba(255,255,255,.08);
      --radius:18px;

      --ok: rgba(16,185,129,.22);
      --warn: rgba(255,170,0,.22);
      --limit: rgba(180,35,24,.22);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(31,111,235,.25), transparent),
                  radial-gradient(900px 500px at 90% 30%, rgba(16,185,129,.18), transparent),
                  var(--bg);
      color:var(--text);
      padding:18px;
    }
    .wrap{max-width:1020px;margin:0 auto; display:grid; gap:14px;}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--ring);
      border-radius: var(--radius);
      padding:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center;}
    .space{justify-content:space-between;}
    .title{font-size:14px; color:var(--muted); letter-spacing:.04em;}
    .big{font-size:44px; font-weight:800; line-height:1;}
    .sub{color:var(--muted); font-size:13px;}
    .pill{
      padding:10px 12px; border-radius:999px; border:1px solid var(--ring);
      background: rgba(0,0,0,.2);
      font-size:13px; color:var(--muted);
    }
    .status{
      width:100%;
      padding:12px 14px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      font-weight:800;
    }
    .btn{
      border:0; border-radius:14px;
      padding:12px 14px; font-weight:900;
      color:white; cursor:pointer;
      background: var(--btn);
      box-shadow: 0 8px 20px rgba(31,111,235,.25);
      min-width:120px;
    }
    .btn.secondary{background: var(--btn2); box-shadow:none;}
    .btn.danger{background: var(--danger); box-shadow:none;}
    .btn.small{padding:10px 12px; min-width:auto; border-radius:12px; font-weight:900;}
    .btn:active{transform: translateY(1px);}

    .grid5{display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap:10px;}
    .grid3{display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px;}

    .chip{
      background: rgba(0,0,0,.22);
      border:1px solid var(--ring);
      border-radius: 14px;
      padding:12px 10px;
      cursor:pointer;
      text-align:center;
      user-select:none;
    }
    .chip .emoji{font-size:22px; display:block; margin-bottom:6px;}
    .chip .lbl{font-size:12px; color:var(--muted);}
    .chip.active{outline: 2px solid rgba(31,111,235,.55); background: rgba(31,111,235,.16);}

    .kpis{display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px;}
    .kpi{padding:12px; border-radius:16px; background: rgba(0,0,0,.18); border:1px solid var(--ring);}
    .kpi .v{font-size:18px; font-weight:900;}
    .kpi .t{font-size:12px; color:var(--muted); margin-top:4px;}

    .log{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px; border:1px solid var(--ring);}
    .log th,.log td{padding:10px 10px; font-size:13px; border-bottom:1px solid rgba(255,255,255,.06);}
    .log th{color:var(--muted); text-align:left; font-weight:800; background: rgba(0,0,0,.18);}
    .log tr:last-child td{border-bottom:0;}
    .del{
      border:0; background: rgba(180,35,24,.15); color:#ffd6d6;
      border-radius:10px; padding:6px 10px; font-weight:900; cursor:pointer;
    }

    /* Calendar */
    .calHead{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .calTitle{font-size:18px; font-weight:900;}
    .calGrid{display:grid; grid-template-columns: repeat(7, minmax(0,1fr)); gap:10px; margin-top:10px;}
    .dow{font-size:12px; color:var(--muted); text-align:center;}
    .day{
      border:1px solid var(--ring);
      border-radius:14px;
      background: rgba(0,0,0,.18);
      padding:10px;
      min-height:86px;
      cursor:pointer;
      position:relative;
    }
    .day.muted{opacity:.35; cursor:default;}
    .dayNum{font-weight:900;}
    .badges{position:absolute; right:10px; top:10px; display:flex; gap:6px; align-items:center;}
    .badge{
      border:1px solid var(--ring);
      border-radius:999px;
      padding:3px 7px;
      font-size:12px;
      font-weight:900;
      background: rgba(0,0,0,.25);
      color: var(--text);
    }
    .dot{
      width:12px; height:12px; border-radius:50%;
      border:1px solid rgba(255,255,255,.20);
      background: transparent;
    }
    .dot.ok{background: var(--ok);}
    .dot.warn{background: var(--warn);}
    .dot.limit{background: var(--limit);}
    .daySel{outline:2px solid rgba(31,111,235,.65);}

    /* Sheet (detail panel) */
    .sheetBack{
      position:fixed; inset:0; background: rgba(0,0,0,.55);
      display:none; align-items:flex-end; justify-content:center;
      padding:14px;
    }
    .sheet{
      width:min(860px, 100%);
      border-radius: 22px;
      border:1px solid var(--ring);
      background: linear-gradient(180deg, rgba(15,26,46,.98), rgba(10,18,34,.98));
      box-shadow: 0 30px 90px rgba(0,0,0,.6);
      padding:14px;
    }
    .sheetTop{display:flex; justify-content:space-between; align-items:center; gap:10px;}
    .sheetTitle{font-weight:900; font-size:16px;}
    .seg{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .seg button{
      border:1px solid var(--ring);
      background: rgba(0,0,0,.20);
      color: var(--text);
      padding:10px 12px;
      border-radius: 14px;
      font-weight:900;
      cursor:pointer;
      min-width: 90px;
    }
    .seg button.active{outline:2px solid rgba(31,111,235,.65); background: rgba(31,111,235,.18);}
    .sheetBody{margin-top:10px; display:grid; gap:10px;}
    .sheetKpi{display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px;}
    .hint{font-size:12px; color:var(--muted);}

    @media (max-width:820px){
      .grid5{grid-template-columns: repeat(2, minmax(0,1fr));}
      .kpis{grid-template-columns: repeat(2, minmax(0,1fr));}
      .sheetKpi{grid-template-columns: repeat(1, minmax(0,1fr));}
    }
  </style>
</head>
<body>
<div class="wrap">

  <!-- Today -->
  <div class="card">
    <div class="row space">
      <div>
        <div class="title">Today</div>
        <div class="big" id="countToday">0</div>
        <div class="sub" id="dateStr"></div>
      </div>
      <div class="row" style="gap:10px;">
        <div class="pill">åˆ†è§£é€Ÿåº¦: <b id="metRateTxt">7</b> g/æ™‚</div>
        <button class="btn secondary" id="clearTodayBtn">ä»Šæ—¥ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>

    <div style="height:10px"></div>

    <div class="kpis">
      <div class="kpi">
        <div class="v"><span id="lastTime">--:--</span></div>
        <div class="t">ç›´è¿‘ã®å…¥åŠ›æ™‚åˆ»</div>
      </div>
      <div class="kpi">
        <div class="v"><span id="sincePrev">--</span></div>
        <div class="t">å‰å›ã‹ã‚‰ã®çµŒé</div>
      </div>
      <div class="kpi">
        <div class="v"><span id="totalG">0.0</span> g</div>
        <div class="t">ä»Šæ—¥ã®ç´¯è¨ˆã‚¢ãƒ«ã‚³ãƒ¼ãƒ«</div>
      </div>
      <div class="kpi">
        <div class="v"><span id="soberAt">--:--</span></div>
        <div class="t">åˆ†è§£å®Œäº†äºˆæ¸¬</div>
      </div>
    </div>

    <div style="height:10px"></div>
    <div class="status" id="statusBar">OKï¼ˆã¾ã ä½™è£•ï¼‰</div>
    <div class="hint" style="margin-top:8px;">
      ç›®å®‰ï¼šç´”ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«(g) = ml Ã— åº¦æ•° Ã— 0.789 / 100ã€‚åˆ†è§£é€Ÿåº¦ã¯7g/æ™‚ã§ä»®ç½®ãã€‚
    </div>
  </div>

  <!-- Register -->
  <div class="card">
    <div class="row space">
      <div class="title">ç™»éŒ²ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ã§é¸ã¶ï¼‰</div>
      <div class="pill">1æ¯ã®ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«: <b id="thisG">0.0</b> g</div>
    </div>

    <div style="height:10px"></div>
    <div class="grid5" id="drinkGrid"></div>

    <div style="height:12px"></div>
    <div class="row space">
      <div class="title">é‡</div>
      <div class="pill">Sï¼ˆãƒŸãƒ‹ï¼‰/ Mï¼ˆã‚¸ãƒ§ãƒƒã‚­ï¼‰/ Lï¼ˆãƒ¡ã‚¬ or ç“¶ï¼‰</div>
    </div>
    <div style="height:10px"></div>
    <div class="grid3" id="sizeGrid"></div>

    <div style="height:12px"></div>
    <div class="row">
      <button class="btn" id="addBtn">ï¼‹ è¿½åŠ </button>
      <button class="btn secondary" id="undoBtn" title="ç›´å‰ã®å‰Šé™¤ã‚’å¾©å…ƒï¼ˆ1å›ï¼‰">å–ã‚Šæ¶ˆã—</button>
    </div>
  </div>

  <!-- Log today -->
  <div class="card">
    <div class="row space">
      <div class="title">Logï¼ˆä»Šæ—¥ï¼‰</div>
      <button class="btn danger" id="clearLogBtn">ãƒ­ã‚°æ¶ˆå»</button>
    </div>
    <div style="height:10px"></div>
    <table class="log">
      <thead>
        <tr>
          <th style="width:110px;">æ™‚åˆ»</th>
          <th>å†…å®¹</th>
          <th style="width:120px;">g</th>
          <th style="width:140px;">å‰å›ã‹ã‚‰</th>
          <th style="width:90px;">å‰Šé™¤</th>
        </tr>
      </thead>
      <tbody id="logBody">
        <tr><td colspan="5" class="sub">(no log)</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Calendar -->
  <div class="card">
    <div class="calHead">
      <div>
        <div class="title">Logï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼‰</div>
        <div class="calTitle" id="calTitle">----</div>
        <div class="hint">â—=é…’é‡ï¼ˆç·‘/é»„/èµ¤ï¼‰ã€€æ•°å­—=äºŒæ—¥é…”ã„ï¼ˆ0ã€œ3ï¼‰ã€€ã‚¿ãƒƒãƒ—ã§å…¥åŠ›</div>
      </div>
      <div class="row" style="gap:8px;">
        <button class="btn secondary small" id="prevMonthBtn">â†</button>
        <button class="btn secondary small" id="todayMonthBtn">ä»Šæœˆ</button>
        <button class="btn secondary small" id="nextMonthBtn">â†’</button>
      </div>
    </div>

    <div class="calGrid" id="dowRow">
      <div class="dow">æ—¥</div><div class="dow">æœˆ</div><div class="dow">ç«</div><div class="dow">æ°´</div><div class="dow">æœ¨</div><div class="dow">é‡‘</div><div class="dow">åœŸ</div>
    </div>
    <div class="calGrid" id="calGrid"></div>
  </div>

</div>

<!-- Detail sheet -->
<div class="sheetBack" id="sheetBack">
  <div class="sheet">
    <div class="sheetTop">
      <div class="sheetTitle" id="sheetTitle">----</div>
      <button class="btn secondary small" id="closeSheetBtn">é–‰ã˜ã‚‹</button>
    </div>

    <div class="sheetBody">
      <div class="sheetKpi">
        <div class="kpi">
          <div class="v"><span id="sheetTotalG">0.0</span> g</div>
          <div class="t">ãã®æ—¥ã®ç´¯è¨ˆã‚¢ãƒ«ã‚³ãƒ¼ãƒ«</div>
        </div>
        <div class="kpi">
          <div class="v"><span id="sheetLevel">--</span></div>
          <div class="t">é…’é‡ãƒ¬ãƒ™ãƒ«</div>
        </div>
        <div class="kpi">
          <div class="v"><span id="sheetHangover">--</span></div>
          <div class="t">äºŒæ—¥é…”ã„ï¼ˆ0ã€œ3ï¼‰</div>
        </div>
      </div>

      <div class="card" style="padding:12px; box-shadow:none;">
        <div class="title">äºŒæ—¥é…”ã„ã‚’å…¥åŠ›ï¼ˆ0ã€œ3ï¼‰</div>
        <div style="height:8px"></div>
        <div class="seg" id="hangoverSeg"></div>
        <div class="hint" style="margin-top:8px;">0=ãªã— / 1=è»½ã„ / 2=ä¸­ / 3=é‡ã„</div>
      </div>

      <div class="card" style="padding:12px; box-shadow:none;">
        <div class="row space">
          <div class="title">é£²é…’ãƒ­ã‚°ï¼ˆãã®æ—¥ï¼‰</div>
          <button class="btn danger small" id="deleteDayBtn">ãã®æ—¥ã®ãƒ­ã‚°ã‚’å…¨æ¶ˆå»</button>
        </div>
        <div style="height:8px"></div>
        <table class="log">
          <thead>
          <tr>
            <th style="width:110px;">æ™‚åˆ»</th>
            <th>å†…å®¹</th>
            <th style="width:120px;">g</th>
            <th style="width:90px;">å‰Šé™¤</th>
          </tr>
          </thead>
          <tbody id="sheetLogBody">
            <tr><td colspan="4" class="sub">(no log)</td></tr>
          </tbody>
        </table>
      </div>

      <div class="hint">â€»ã“ã®ã‚¢ãƒ—ãƒªã¯æ¨å®šã§ã™ã€‚é‹è»¢åˆ¤æ–­ã®ä»£æ›¿ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
    </div>
  </div>
</div>

<script>
  // ====== constants / settings ======
  const ETHANOL_DENSITY = 0.789;
  const settings = {
    metabolize_g_per_hour: 7,
    thresholds_g: { ok: 40, warn: 80, limit: 120 }, // Phase2ç”¨ï¼šæ—¥åˆè¨ˆã®è‰²åˆ†ã‘ï¼ˆå®Ÿç”¨å¯„ã‚Šï¼‰
  };

  const DRINKS = [
    { key:"beer",     label:"ãƒ“ãƒ¼ãƒ«",     emoji:"ğŸº",   abv:5.0,  ml:{ S:200, M:400, L:650 } },
    { key:"highball", label:"ãƒã‚¤ãƒœãƒ¼ãƒ«", emoji:"ğŸ¥ƒ",   abv:7.0,  ml:{ S:250, M:350, L:500 } },
    { key:"wine",     label:"ãƒ¯ã‚¤ãƒ³",     emoji:"ğŸ·",   abv:12.0, ml:{ S:100, M:150, L:250 } },
    { key:"craft",    label:"ã‚¯ãƒ©ãƒ•ãƒˆ",   emoji:"ğŸºâœ¨", abv:6.5,  ml:{ S:200, M:400, L:650 } },
    { key:"brandy",   label:"ãƒ–ãƒ©ãƒ³ãƒ‡ãƒ¼", emoji:"ğŸ¥ƒâœ¨", abv:40.0, ml:{ S:30,  M:45,  L:60  } },
  ];

  // ====== helpers ======
  const pad2 = (n)=>String(n).padStart(2,"0");
  const ymd = (d)=>{
    const dt = (d instanceof Date) ? d : new Date(d);
    return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}`;
  };
  const gramsOfAlcohol = (ml, abvPercent) => (ml * (abvPercent/100) * ETHANOL_DENSITY);
  const fmtTime = (d) => `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  const fmtDur = (ms) => {
    const min = Math.max(0, Math.round(ms/60000));
    const h = Math.floor(min/60);
    const m = min%60;
    if (min===0) return "0åˆ†";
    if (h===0) return `${m}åˆ†`;
    return `${h}æ™‚é–“${m}åˆ†`;
  };
  const getDrink = (key) => DRINKS.find(d=>d.key===key);

  // ====== storage keys ======
  const drinkKey = (dateStr)=> `drinklog_${dateStr}`;
  const hangKey  = (dateStr)=> `hangover_${dateStr}`;

  const loadLogByDate = (dateStr)=>{
    try{
      const raw = localStorage.getItem(drinkKey(dateStr));
      return raw ? JSON.parse(raw) : [];
    }catch(e){ return []; }
  };
  const saveLogByDate = (dateStr, log)=> localStorage.setItem(drinkKey(dateStr), JSON.stringify(log));

  const loadHangover = (dateStr)=>{
    const raw = localStorage.getItem(hangKey(dateStr));
    if (raw===null || raw===undefined || raw==="") return null;
    const v = Number(raw);
    if (Number.isNaN(v)) return null;
    return Math.max(0, Math.min(3, v));
  };
  const saveHangover = (dateStr, v)=> localStorage.setItem(hangKey(dateStr), String(v));

  const sumG = (log)=> log.reduce((s,x)=>s + (x.g||0), 0);

  const levelOf = (totalG)=>{
    const { ok, warn, limit } = settings.thresholds_g;
    if (totalG >= limit) return { key:"limit", label:"ä¸Šé™", cls:"limit" };
    if (totalG >= warn)  return { key:"warn",  label:"æ³¨æ„", cls:"warn" };
    if (totalG >= ok)    return { key:"ok",    label:"é©é‡", cls:"ok" };
    return { key:"none",  label:"-", cls:"" };
  };

  // ====== UI state ======
  let selectedDrinkKey = "highball";
  let selectedSize = "M";
  let lastDeleted = null;

  let calCursor = new Date(); // month cursor
  calCursor.setDate(1);

  let sheetDate = null; // "YYYY-MM-DD"

  // ====== DOM refs ======
  document.getElementById("metRateTxt").textContent = settings.metabolize_g_per_hour;

  const drinkGrid = document.getElementById("drinkGrid");
  const sizeGrid  = document.getElementById("sizeGrid");
  const thisGEl   = document.getElementById("thisG");

  const countTodayEl = document.getElementById("countToday");
  const dateStrEl = document.getElementById("dateStr");
  const lastTimeEl = document.getElementById("lastTime");
  const sincePrevEl = document.getElementById("sincePrev");
  const totalGEl = document.getElementById("totalG");
  const soberAtEl = document.getElementById("soberAt");
  const statusBar = document.getElementById("statusBar");
  const logBody   = document.getElementById("logBody");

  const calTitleEl = document.getElementById("calTitle");
  const calGridEl  = document.getElementById("calGrid");

  const sheetBack = document.getElementById("sheetBack");
  const sheetTitleEl = document.getElementById("sheetTitle");
  const sheetTotalGEl = document.getElementById("sheetTotalG");
  const sheetLevelEl = document.getElementById("sheetLevel");
  const sheetHangEl = document.getElementById("sheetHangover");
  const hangSegEl = document.getElementById("hangoverSeg");
  const sheetLogBody = document.getElementById("sheetLogBody");

  // ====== render drink chips ======
  const computeThisG = () => {
    const d = getDrink(selectedDrinkKey);
    const ml = d.ml[selectedSize];
    return gramsOfAlcohol(ml, d.abv);
  };

  const renderDrinkChips = () => {
    drinkGrid.innerHTML = "";
    DRINKS.forEach(d=>{
      const div = document.createElement("div");
      div.className = "chip" + (d.key===selectedDrinkKey ? " active": "");
      div.innerHTML = `<span class="emoji">${d.emoji}</span><div style="font-weight:900">${d.label}</div><div class="lbl">${d.abv}%</div>`;
      div.onclick = ()=>{ selectedDrinkKey = d.key; renderAll(); };
      drinkGrid.appendChild(div);
    });
  };

  const renderSizeChips = () => {
    sizeGrid.innerHTML = "";
    const d = getDrink(selectedDrinkKey);
    ["S","M","L"].forEach(s=>{
      const ml = d.ml[s];
      const label = (s==="S") ? "Sï¼ˆãƒŸãƒ‹ï¼‰" : (s==="M" ? "Mï¼ˆã‚¸ãƒ§ãƒƒã‚­ï¼‰" : "Lï¼ˆãƒ¡ã‚¬/ç“¶ï¼‰");
      const div = document.createElement("div");
      div.className = "chip" + (s===selectedSize ? " active": "");
      div.innerHTML = `<div style="font-weight:900">${label}</div><div class="lbl">${ml} ml</div>`;
      div.onclick = ()=>{ selectedSize = s; renderAll(); };
      sizeGrid.appendChild(div);
    });
  };

  // ====== today section ======
  const todayStr = ()=> ymd(new Date());

  const calcSoberAt = (totalG)=>{
    const hoursNeeded = totalG / settings.metabolize_g_per_hour;
    const now = new Date();
    return new Date(now.getTime() + hoursNeeded*3600*1000);
  };

  const setStatus = (totalG) => {
    // Phase1ã®STOPã¯å¼·ã™ãã‚‹ã®ã§ã€ä»Šæ—¥è¡¨ç¤ºã¯é–¾å€¤ã‚’å°‘ã—æ§ãˆã‚ã«
    if (totalG >= 80){
      statusBar.textContent = "ä¸Šé™åˆ°é”ï¼ˆã“ã‚Œä»¥ä¸Šã¯å±é™ºï¼‰";
      statusBar.style.background = "rgba(180,35,24,.28)";
      statusBar.style.borderColor = "rgba(180,35,24,.55)";
      return;
    }
    if (totalG >= 40){
      statusBar.textContent = "æ³¨æ„ï¼ˆãƒšãƒ¼ã‚¹ã‚’è½ã¨ã™ï¼‰";
      statusBar.style.background = "rgba(255,170,0,.20)";
      statusBar.style.borderColor = "rgba(255,170,0,.45)";
      return;
    }
    if (totalG >= 20){
      statusBar.textContent = "é©é‡ï¼ˆãã‚ãã‚æ„è­˜ï¼‰";
      statusBar.style.background = "rgba(16,185,129,.16)";
      statusBar.style.borderColor = "rgba(16,185,129,.35)";
      return;
    }
    statusBar.textContent = "OKï¼ˆã¾ã ä½™è£•ï¼‰";
    statusBar.style.background = "rgba(16,185,129,.10)";
    statusBar.style.borderColor = "rgba(255,255,255,.12)";
  };

  const renderTodayLogTable = (log) => {
    if (log.length===0){
      logBody.innerHTML = `<tr><td colspan="5" class="sub">(no log)</td></tr>`;
      return;
    }
    logBody.innerHTML = "";
    for (let i=0;i<log.length;i++){
      const e = log[i];
      const prev = log[i-1];
      const delta = prev ? fmtDur(e.t - prev.t) : "--";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${fmtTime(new Date(e.t))}</td>
        <td>${e.emoji} ${e.label} / ${e.size}ï¼ˆ${e.ml}mlãƒ»${e.abv}%ï¼‰</td>
        <td><b>${e.g.toFixed(1)}</b> g</td>
        <td>${delta}</td>
        <td><button class="del" data-id="${e.id}">å‰Šé™¤</button></td>
      `;
      logBody.appendChild(tr);
    }
    [...logBody.querySelectorAll("button.del")].forEach(btn=>{
      btn.onclick = ()=>{
        const id = btn.getAttribute("data-id");
        const cur = loadLogByDate(todayStr());
        const idx = cur.findIndex(x=>x.id===id);
        if (idx>=0){
          lastDeleted = cur[idx];
          cur.splice(idx,1);
          saveLogByDate(todayStr(), cur);
          renderAll();
          renderCalendar();
        }
      };
    });
  };

  const renderToday = () => {
    const now = new Date();
    dateStrEl.textContent = ymd(now);

    const log = loadLogByDate(todayStr());
    countTodayEl.textContent = String(log.length);

    const last = log[log.length-1];
    if (!last){
      lastTimeEl.textContent = "--:--";
      sincePrevEl.textContent = "--";
    } else {
      lastTimeEl.textContent = fmtTime(new Date(last.t));
      const prev = log[log.length-2];
      sincePrevEl.textContent = prev ? fmtDur(last.t - prev.t) : "--";
    }

    const total = sumG(log);
    totalGEl.textContent = total.toFixed(1);
    soberAtEl.textContent = log.length ? fmtTime(calcSoberAt(total)) : "--:--";
    setStatus(total);

    renderTodayLogTable(log);
  };

  // ====== calendar ======
  const monthLabel = (d)=> `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ`;

  const daysInMonth = (y, m0)=> new Date(y, m0+1, 0).getDate(); // m0: 0-11
  const firstDow = (y, m0)=> new Date(y, m0, 1).getDay(); // 0:Sun

  const renderCalendar = () => {
    const y = calCursor.getFullYear();
    const m0 = calCursor.getMonth();
    calTitleEl.textContent = monthLabel(calCursor);

    calGridEl.innerHTML = "";
    const start = firstDow(y, m0);
    const dim = daysInMonth(y, m0);

    // å‰æœˆåŸ‹ã‚
    const prevDim = daysInMonth(y, m0-1);
    for (let i=0;i<start;i++){
      const dayNum = prevDim - (start-1-i);
      const cell = document.createElement("div");
      cell.className = "day muted";
      cell.innerHTML = `<div class="dayNum">${dayNum}</div>`;
      calGridEl.appendChild(cell);
    }

    // å½“æœˆ
    for (let d=1; d<=dim; d++){
      const ds = `${y}-${pad2(m0+1)}-${pad2(d)}`;
      const log = loadLogByDate(ds);
      const total = sumG(log);
      const lvl = levelOf(total);
      const hang = loadHangover(ds);

      const cell = document.createElement("div");
      cell.className = "day" + (ds===sheetDate ? " daySel" : "");
      const dotCls = (lvl.cls ? `dot ${lvl.cls}` : "dot");
      const hangBadge = (hang===null ? "" : `<span class="badge">${hang}</span>`);
      const dot = (total>0 ? `<span class="${dotCls}" title="${lvl.label}: ${total.toFixed(1)}g"></span>` : `<span class="dot"></span>`);

      cell.innerHTML = `
        <div class="dayNum">${d}</div>
        <div class="badges">${dot}${hangBadge}</div>
        <div class="hint" style="margin-top:18px;">${total>0 ? total.toFixed(0)+"g" : ""}</div>
      `;
      cell.onclick = ()=> openSheet(ds);
      calGridEl.appendChild(cell);
    }

    // æ¬¡æœˆåŸ‹ã‚ï¼ˆ7åˆ—ã‚’æƒãˆã‚‹ï¼‰
    const totalCells = start + dim;
    const remain = (7 - (totalCells % 7)) % 7;
    for (let i=1;i<=remain;i++){
      const cell = document.createElement("div");
      cell.className = "day muted";
      cell.innerHTML = `<div class="dayNum">${i}</div>`;
      calGridEl.appendChild(cell);
    }
  };

  // ====== sheet (day detail) ======
  const renderHangoverSeg = (ds) => {
    hangSegEl.innerHTML = "";
    const current = loadHangover(ds);
    for (let v=0; v<=3; v++){
      const btn = document.createElement("button");
      btn.textContent = String(v);
      btn.className = (current===v) ? "active" : "";
      btn.onclick = ()=>{
        saveHangover(ds, v);
        renderSheet(ds);
        renderCalendar();
      };
      hangSegEl.appendChild(btn);
    }
  };

  const renderSheetLog = (ds) => {
    const log = loadLogByDate(ds);
    if (log.length===0){
      sheetLogBody.innerHTML = `<tr><td colspan="4" class="sub">(no log)</td></tr>`;
      return;
    }
    sheetLogBody.innerHTML = "";
    for (const e of log){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${fmtTime(new Date(e.t))}</td>
        <td>${e.emoji} ${e.label} / ${e.size}ï¼ˆ${e.ml}mlãƒ»${e.abv}%ï¼‰</td>
        <td><b>${e.g.toFixed(1)}</b> g</td>
        <td><button class="del" data-id="${e.id}">å‰Šé™¤</button></td>
      `;
      sheetLogBody.appendChild(tr);
    }
    [...sheetLogBody.querySelectorAll("button.del")].forEach(btn=>{
      btn.onclick = ()=>{
        const id = btn.getAttribute("data-id");
        const cur = loadLogByDate(ds);
        const idx = cur.findIndex(x=>x.id===id);
        if (idx>=0){
          cur.splice(idx,1);
          saveLogByDate(ds, cur);
          renderSheet(ds);
          renderCalendar();
          if (ds===todayStr()) renderToday();
        }
      };
    });
  };

  const renderSheet = (ds) => {
    sheetTitleEl.textContent = ds;
    const log = loadLogByDate(ds);
    const total = sumG(log);
    const lvl = levelOf(total);
    const hang = loadHangover(ds);

    sheetTotalGEl.textContent = total.toFixed(1);
    sheetLevelEl.textContent = (total>0 ? `${lvl.label}ï¼ˆ${total.toFixed(0)}gï¼‰` : "-");
    sheetHangEl.textContent = (hang===null ? "æœªå…¥åŠ›" : String(hang));

    renderHangoverSeg(ds);
    renderSheetLog(ds);
  };

  const openSheet = (ds) => {
    sheetDate = ds;
    renderSheet(ds);
    sheetBack.style.display = "flex";
    renderCalendar(); // selection highlight
  };
  const closeSheet = () => {
    sheetBack.style.display = "none";
    sheetDate = null;
    renderCalendar();
  };

  document.getElementById("closeSheetBtn").onclick = closeSheet;
  sheetBack.addEventListener("click", (e)=>{
    if (e.target===sheetBack) closeSheet();
  });

  document.getElementById("deleteDayBtn").onclick = ()=>{
    if (!sheetDate) return;
    if (!confirm(`${sheetDate} ã®é£²é…’ãƒ­ã‚°ã‚’å…¨éƒ¨æ¶ˆã—ã¾ã™ã€‚OKï¼Ÿ`)) return;
    saveLogByDate(sheetDate, []);
    renderSheet(sheetDate);
    renderCalendar();
    if (sheetDate===todayStr()) renderToday();
  };

  // ====== actions ======
  document.getElementById("addBtn").onclick = () => {
    const d = getDrink(selectedDrinkKey);
    const ml = d.ml[selectedSize];
    const g = gramsOfAlcohol(ml, d.abv);
    const ds = todayStr();
    const log = loadLogByDate(ds);
    const entry = {
      id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random()),
      t: Date.now(),
      key: d.key,
      label: d.label,
      emoji: d.emoji,
      size: selectedSize,
      ml,
      abv: d.abv,
      g
    };
    log.push(entry);
    saveLogByDate(ds, log);
    lastDeleted = null;
    renderAll();
    renderCalendar();
  };

  document.getElementById("undoBtn").onclick = () => {
    if (!lastDeleted) return;
    const ds = todayStr();
    const log = loadLogByDate(ds);
    log.push(lastDeleted);
    log.sort((a,b)=>a.t-b.t);
    saveLogByDate(ds, log);
    lastDeleted = null;
    renderAll();
    renderCalendar();
  };

  document.getElementById("clearLogBtn").onclick = () => {
    if (!confirm("ä»Šæ—¥ã®ãƒ­ã‚°ã‚’å…¨éƒ¨æ¶ˆã—ã¾ã™ã€‚OKï¼Ÿ")) return;
    saveLogByDate(todayStr(), []);
    lastDeleted = null;
    renderAll();
    renderCalendar();
  };

  document.getElementById("clearTodayBtn").onclick = () => {
    if (!confirm("ä»Šæ—¥ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ­ã‚°æ¶ˆå»ï¼‰ã—ã¾ã™ã€‚OKï¼Ÿ")) return;
    saveLogByDate(todayStr(), []);
    lastDeleted = null;
    renderAll();
    renderCalendar();
  };

  // Calendar nav
  document.getElementById("prevMonthBtn").onclick = ()=>{
    calCursor = new Date(calCursor.getFullYear(), calCursor.getMonth()-1, 1);
    renderCalendar();
  };
  document.getElementById("nextMonthBtn").onclick = ()=>{
    calCursor = new Date(calCursor.getFullYear(), calCursor.getMonth()+1, 1);
    renderCalendar();
  };
  document.getElementById("todayMonthBtn").onclick = ()=>{
    const n = new Date(); n.setDate(1);
    calCursor = n;
    renderCalendar();
  };

  // ====== render all ======
  const renderAll = () => {
    renderDrinkChips();
    renderSizeChips();
    thisGEl.textContent = computeThisG().toFixed(1);
    renderToday();
  };

  // PWA
  if ("serviceWorker" in navigator){
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }

  renderAll();
  renderCalendar();
</script>
</body>
</html>
